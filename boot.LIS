                         4 .list
                         5 /* „É¨„Ç∏„Çπ„ÇøÂÆöÁæ© */
                         6 .equ REGBASE, 0xfff000 | DMAP „Çí‰ΩøÁî®Ôºé
                         7 .equ IOBASE, 0x00d00000
                         8 
                         9 /* Ââ≤„ÇäËæº„ÅøÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø*/
                        10 .equ IVR, REGBASE+0x300 | Ââ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„É¨„Ç∏„Çπ„Çø
                        11 .equ IMR, REGBASE+0x304 | Ââ≤„ÇäËæº„Åø„Éû„Çπ„ÇØ„É¨„Ç∏„Çπ„Çø
                        12 .equ ISR, REGBASE+0x30c | Ââ≤„ÇäËæº„Åø„Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø
                        13 .equ IPR, REGBASE+0x310 | Ââ≤„ÇäËæº„Åø„Éö„É≥„Éá„Ç£„É≥„Ç∞„É¨„Ç∏„Çπ„Çø
                        14 
                        15 /* „Çø„Ç§„ÉûÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø */
                        16 .equ TCTL1, REGBASE+0x600  | „Çø„Ç§„ÉûÔºë„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        17 .equ TPRER1, REGBASE+0x602 | „Çø„Ç§„ÉûÔºë„Éó„É™„Çπ„Ç±„Éº„É©„É¨„Ç∏„Çπ„Çø
                        18 .equ TCMP1, REGBASE+0x604  | „Çø„Ç§„ÉûÔºë„Ç≥„É≥„Éö„Ç¢„É¨„Ç∏„Çπ„Çø
                        19 .equ TCN1, REGBASE+0x608   | „Çø„Ç§„ÉûÔºë„Ç´„Ç¶„É≥„Çø„É¨„Ç∏„Çπ„Çø
                        20 .equ TSTAT1, REGBASE+0x60a | „Çø„Ç§„ÉûÔºë„Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø
                        21 
                        22 /* UART1ÔºàÈÄÅÂèó‰ø°ÔºâÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø */
                        23 .equ USTCNT1, REGBASE+0x900 | UART1 „Çπ„ÉÜ„Éº„Çø„Çπ/„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        24 .equ UBAUD1, REGBASE+0x902  | UART1 „Éú„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        25 .equ URX1, REGBASE+0x904    | UART1 Âèó‰ø°„É¨„Ç∏„Çπ„Çø
                        26 .equ UTX1, REGBASE+0x906    | UART1 ÈÄÅ‰ø°„É¨„Ç∏„Çπ„Çø
                        27 
                        28 /* LED */
                        29 .equ LED7, IOBASE+0x000002f | „Éú„Éº„ÉâÊê≠Ëºâ„ÅÆ LED Áî®„É¨„Ç∏„Çπ„Çø
                        30 .equ LED6, IOBASE+0x000002d | ‰ΩøÁî®Ê≥ï„Å´„Å§„ÅÑ„Å¶„ÅØ‰ªòÈå≤ A.4.3.1
                        31 .equ LED5, IOBASE+0x000002b
                        32 .equ LED4, IOBASE+0x0000029
                        33 .equ LED3, IOBASE+0x000003f
                        34 .equ LED2, IOBASE+0x000003d
                        35 .equ LED1, IOBASE+0x000003b
                        36 .equ LED0, IOBASE+0x0000039
                        37 
                        38 /* „Çπ„Çø„ÉÉ„ÇØ */
                        39 .section .bss
                        40 .even
0018e0 0000 0000        41 SYS_STK:.ds.b 0x4000
       0000 0000        41 
       0000 0000        41 
       0000 0000        41 
       0000 0000        41 
                        42 .even
                        43 SYS_STK_TOP: | „Ç∑„Çπ„ÉÜ„É†„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü„ÅÆÊúÄÂæåÂ∞æ
                        44 
                        45 /* ÂàùÊúüÂåñ */
                        46 .section .text
                        47 .even
                        48 boot:
000400 46FC 2700        49     move.w #0x2700, %SR     | Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢
000404 4FF9 0000        50     lea.l SYS_STK_TOP, %SP  | „Çπ„Çø„ÉÉ„ÇØ„Éù„Ç§„É≥„Çø„ÅÆË®≠ÂÆö
       0000             50 
                        51 
                        52     /* Ââ≤„ÇäËæº„Åø„Ç≥„É≥„Éà„É≠„Éº„É©„ÅÆÂàùÊúüÂåñ */
00040a 13FC 0040        53     move.b #0x40, IVR       | „É¶„Éº„Ç∂Ââ≤„ÇäËæº„Åø„Éô„ÇØ„ÇøÁï™Âè∑„Çí0x40+level„Å´Ë®≠ÂÆö
       00FF F300        53 
000412 23FC 00FF        54     move.l #0x00ffffff, IMR | ÂÖ®Ââ≤„ÇäËæº„Åø„Éû„Çπ„ÇØ
       FFFF 00FF        54 
       F304             54 
                        55 
00041c 21FC 0000        56     move.l #syscall_handler, 0x080 | TRAP#0„ÅÆÂâ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÇíÁôªÈå≤
       0000 0080        56 
000424 21FC 0000        57     move.l #uart1_interrupt, 0x110 | UART1„ÅÆÂâ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÇíÁôªÈå≤
       0000 0110        57 
00042c 21FC 0000        58     move.l #tmr1_interrupt, 0x118  | TIMER1„ÅÆÂâ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÇíÁôªÈå≤
       0000 0118        58 
                        59 
                        60     /* ÈÄÅÂèó‰ø° (UART1) Èñ¢‰øÇ„ÅÆÂàùÊúüÂåñ (Ââ≤„ÇäËæº„Åø„É¨„Éô„É´„ÅØ 4 „Å´Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã) *
000434 33FC 0000        61     move.w #0x0000, USTCNT1 | „É™„Çª„ÉÉ„Éà
       00FF F900        61 
                        62     * move.w #0xe100, USTCNT1 | ÈÄÅÂèó‰ø°ÂèØËÉΩ, „Éë„É™„ÉÜ„Ç£„Å™„Åó, 1 stop, 8 bit, ÈÄÅÂèóÂâ≤„ÇäËæº
00043c 33FC E108        63     move.w #0xe108, USTCNT1 | Âèó‰ø°Ââ≤„ÇäËæº„ÅøÂèØËÉΩ
       00FF F900        63 
                        64     * move.w #0xe104, USTCNT1   | ÈÄÅ‰ø°Ââ≤„ÇäËæº„ÅøÂèØËÉΩ
000444 33FC 0038        65     move.w #0x0038, UBAUD1  | baud rate = 230400 bps
       00FF F902        65 
                        66 
                        67     /* „Çø„Ç§„ÉûÈñ¢‰øÇ„ÅÆÂàùÊúüÂåñ (Ââ≤„ÇäËæº„Åø„É¨„Éô„É´„ÅØ 6 „Å´Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã) */
00044c 33FC 0004        68     move.w #0x0004, TCTL1   | restart, Ââ≤„ÇäËæº„Åø‰∏çÂèØ,
       00FF F600        68 
                        69                             | „Ç∑„Çπ„ÉÜ„É†„ÇØ„É≠„ÉÉ„ÇØ„ÅÆ 1/16 „ÇíÂçò‰Ωç„Å®„Åó„Å¶Ë®àÊôÇÔºå
                        70                             | „Çø„Ç§„Éû‰ΩøÁî®ÂÅúÊ≠¢
                        71 
000454 4EBA 0066        72     jsr	Init_Q            | „Ç≠„É•„Éº„ÅÆÂàùÊúüÂåñ
                        73 
                        74     * move.l #0xff3ffb, IMR | UART1„ÅÆÂâ≤„ÇäËæº„Åø„ÇíË®±ÂèØ
000458 23FC 00FF        75     move.l #0xff3ff9, IMR | UART1,TIMER„ÅÆÂâ≤„ÇäËæº„Åø„ÇíË®±ÂèØ
       3FF9 00FF        75 
       F304             75 
000462 46FC 2000        76     move.w #0x2000, %SR   | „Çπ„Éº„Éë„Éº„Éê„Ç§„Ç∂„É¢„Éº„Éâ„ÉªËµ∞Ë°å„É¨„Éô„É´„ÅØ0
000466 6000 032E        77     bra MAIN
                        78 
                        79 /* Ââ≤„ÇäËæº„Åø„Éè„É≥„Éâ„É© */
                        80 .include "syscall.s"
                        -4 .equ SYSCALL_NUM_GETSTRING,   1
                        -3 .equ SYSCALL_NUM_PUTSTRING,   2
                        -2 .equ SYSCALL_NUM_RESET_TIMER, 3
                        -1 .equ SYSCALL_NUM_SET_TIMER,   4
                         0 
                         1 /*
                         2  * syscall_handler
                         3  * %d0: syscall number
                         4  * %dx: syscall argument
                         5  */
                         6 syscall_handler:
00046a 48E7 7FFE         7     movem.l %D1-%D7/%A0-%A6, -(%SP)
                         8 
00046e 0C80 0000         9 	cmpi.l #SYSCALL_NUM_GETSTRING, %D0
       0001              9 
000474 6700 0026        10 	beq CALL_GETSTRING
                        11 
000478 0C80 0000        12 	cmpi.l #SYSCALL_NUM_PUTSTRING, %D0
       0002             12 
00047e 6700 0024        13 	beq CALL_PUTSTRING
                        14     
000482 0C80 0000        15     cmpi.l #SYSCALL_NUM_RESET_TIMER, %D0
       0003             15 
000488 6700 0022        16     beq CALL_RESET_TIMER
                        17     
                        18 
00048c 0C80 0000        19 	cmpi.l #SYSCALL_NUM_SET_TIMER, %D0
       0004             19 
000492 6700 0020        20 	beq CALL_SET_TIMER
                        21     
                        22     
                        23 END_SYSCALL_HNDR:
000496 4CDF 7FFE        24     movem.l (%SP)+, %D1-%D7/%A0-%A6
00049a 4E73             25 	rte
                        26 
                        27 CALL_GETSTRING:
00049c 4EBA 0226        28 	jsr GETSTRING
0004a0 6000 FFF4        29 	 bra END_SYSCALL_HNDR
                        30 
                        31 CALL_PUTSTRING:
0004a4 4EBA 00B4        32 	jsr PUTSTRING
0004a8 6000 FFEC        33 	bra END_SYSCALL_HNDR
                        34 	
                        35 CALL_RESET_TIMER:
0004ac 4EBA 024E        36 	jsr RESET_TIMER
0004b0 6000 FFE4        37 	bra END_SYSCALL_HNDR
                        38 CALL_SET_TIMER:
0004b4 4EBA 0250        39 	jsr SET_TIMER
0004b8 6000 FFDC        40 	bra END_SYSCALL_HNDR
                        81 .include "queue.s"
                        -4 .section .text
                        -3 
                        -2 
                        -1 *****************„Ç≠„É•„Éº„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ*******************************************************
                         0 Init_Q:
0004bc 48E7 F8F0         1 	movem.l %d0-%d4/%a0-%a3,-(%sp)
0004c0 7000              2 	moveq 	#0, %d0			/* d0: „Ç≠„É•„ÉºÁï™Âè∑„Åã„Å§„Ç´„Ç¶„É≥„Çø */
0004c2 43F9 0000         3 	lea.l	Q_INFO, %a1		/* a1: Q_INFO„ÅÆÈñãÂßãÂú∞ÁÇπ */
       0000              3 
0004c8 45F9 0000         4 	lea.l	Q0_START, %a2 		/* a2: Q0„ÅÆÂÖàÈ†≠Áï™Âú∞ */
       0000              4 
0004ce 343C 0100         5 	move.w	#B_SIZE, %d2		/* d2: 256 */
0004d2 363C 0014         6 	move.w	#Q_INFO_SIZE, %d3	/* d3: 20 („Ç≠„É•„ÉºÔºëÂÄãÂàÜ„ÅÆÊÉÖÂ†±Èáè) */
                         7 
                         8 LOOP_Init:				/* d4: Ë®àÁÆóÁî® */
0004d6 2800              9 	move.l	%d0,	%d4
0004d8 C8C3             10 	mulu	%d3,	%d4		/* d4 = d0 * Q_INFO_SIZE */
0004da 2044             11 	move.l	%d4,	%a0
0004dc D1C9             12 	add.l	%a1,	%a0		/* a0 = Q_INFO + d0 * Q_INFO_SIZE(ÂêÑ„Ç≠„É•„ÉºÊÉÖÂ†±„ÅÆÂÖàÈ†≠) */
                        13 	
0004de 2800             14 	move.l	%d0,	%d4			
0004e0 C8C2             15 	mulu	%d2,	%d4		/* d4 = d0 * B_SIZE */
0004e2 2644             16 	move.l	%d4,	%a3
0004e4 D7CA             17 	add.l	%a2,	%a3		/* a3 = Q0_START + d0 * B_SIZE(ÂêÑ„Ç≠„É•„Éº„ÅÆÂÖàÈ†≠) */
                        18 
0004e6 214B 0000        19 	move.l	%a3,	TOP_OFS(%a0)	
0004ea 214B 0004        20 	move.l	%a3,	OUT_OFS(%a0)
0004ee 214B 0008        21 	move.l	%a3,	IN_OFS(%a0)
                        22 	
0004f2 D7FC 0000        23 	adda.l	#B_SIZE_MINUS,	%a3
       00FF             23 
0004f8 214B 000C        24 	move.l	%a3,	BOTTOM_OFS(%a0)
0004fc 217C 0000        25 	move.l	#0,	S_OFS(%a0)
       0000 0010        25 
                        26 
000504 5240             27 	addq	#1,	%d0
000506 0C40 0002        28 	cmp	#2,	%d0
00050a 6600 FFCA        29 	bne	LOOP_Init		/* „Ç≠„É•„Éº2„Å§ÂàÜÁπ∞Ëøî„Åó */
                        30 	
                        31 end_Init:	
00050e 4CDF 0F1F        32 	movem.l (%sp)+, %d0-%d4/%a0-%a3
000512 4E75             33 	rts
                        34 ***************************************************************************************************
                        35 
                        36 
                        37 ******INTERPUT*************************************************************************************
                        38 ** ÂÖ•ÂäõÔºöd1.lÔºà„ÉÅ„É£„É≥„Éç„É´Ôºâ	
                        39 INTERPUT:
000514 48E7 E000        40 	movem.l %d0-%d2,-(%sp)
                        41 	
                        42 	/* (1) */
000518 46FC 2700        43 	move.w  #0x2700, %sr
                        44 	/* (2) */
00051c 0C41 0000        45 	cmpi #0, %d1
000520 6600 0032        46 	bne	End_INTERPUT
                        47 	/* (3) */
000524 7001             48 	moveq	#1, %d0
000526 4EBA 0104        49 	jsr	OUTQ
                        50 	*Âá∫ÂäõÔºëÔºöd0(Â§±Êïó 0/ ÊàêÂäü 1 )
                        51 	*Âá∫ÂäõÔºíÔºöd1ÔºàÂèñ„ÇäÂá∫„Åó„Åü8bit„Éá„Éº„ÇøÔºâ
                        52 	/* (4) */
00052a 0C40 0000        53 	cmpi #0, %d0
00052e 6700 0010        54 	beq	INTERPUT_MASK
                        55 	/* (5) */
                        56 	/* d1„ÇíUTX1„Å´‰ª£ÂÖ•Ôºà‰∏ã‰ΩçÔºòbitÔºâ */
000532 0041 0800        57 	ori #0x0800, %D1                | „Éò„ÉÉ„ÉÄ„Çí‰ª£ÂÖ•
000536 33C1 00FF        58 	move.w %D1, UTX1                | ÈÄÅ‰ø°
       F906             58 
00053c 6000 0016        59 	bra	End_INTERPUT
                        60 INTERPUT_MASK:
                        61 	/* (4)' */
                        62 	/* „Éû„Çπ„ÇØÊìç‰Ωú */
000540 3439 00FF        63 	move.w	USTCNT1, %d2
       F900             63 
000546 0242 FFFB        64 	andi.w	#0xFFFB, %d2	/* 0xFFFB = 1111111111111011 */
00054a 33C2 00FF        65 	move.w	%d2,	USTCNT1 /* ÈÄÅ‰ø°Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÄÅUSTCNT1„ÅÆTXEE„Çí0„Å´„Åô„Çã */
       F900             65 
000550 6000 0002        66 	bra End_INTERPUT
                        67 End_INTERPUT:
000554 4CDF 0007        68 	movem.l (%sp)+, %d0-%d2
000558 4E75             69 	rts
                        70 
                        71 	
                        72 ***************************************************************************************************
                        73 
                        74 *********PUTSTRING*********************************************************************************
                        75 ** ÂÖ•ÂäõÔºëÔºö „ÉÅ„É£„Éç„É´ ch ‚Üí %D1.L
                        76 ** ÂÖ•ÂäõÔºíÔºö„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÖà„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ p ‚Üí %D2.L
                        77 ** ÂÖ•ÂäõÔºìÔºöÈÄÅ‰ø°„Åô„Çã„Éá„Éº„ÇøÊï∞ size ‚Üí %D3.L
                        78 ** Âá∫Âäõ  ÔºöÂÆüÈöõ„Å´ÈÄÅ‰ø°„Åó„Åü„Éá„Éº„ÇøÊï∞ sz ‚Üí %D0.L
                        79 	
                        80 PUTSTRING:
00055a 48E7 7E80        81 	movem.l %d1-%d6/%a0,-(%sp)
                        82 	/* (1) */
00055e 0C41 0000        83 	cmpi #0, %d1
000562 6600 003E        84 	bne	End_PUTSTRING
                        85 	/* (2) */
000566 7800             86 	moveq	#0, %d4  /* d4 = sz = 0 */
000568 2042             87 	movea.l	%d2, %a0 /* a0 = i = p */
                        88 	/* (3) */
00056a 0C43 0000        89 	cmpi #0, %d3
00056e 6700 0030        90 	beq	PUTSTRING_10
                        91 LOOP_PUTSTRING:	
                        92 	/* (4) */
000572 B843             93 	cmp	%d3, %d4
000574 6700 001A        94 	beq	PUTSTRING_9
                        95 	/* (5) */
000578 7001             96 	moveq	#1, %d0
00057a 1210             97 	move.b	(%a0), %d1
00057c 4EBA 002A        98 	jsr	INQ
                        99 	*d0 :„Ç≠„É•„ÉºÁï™Âè∑
                       100 	*d1 :8bit„Éá„Éº„Çø
                       101 	*Âá∫ÂäõÔºöd0(Â§±Êïó 0/ ÊàêÂäü 1 )
                       102 	/* (6) */
000580 0C40 0000       103 	cmpi #0, %d0
000584 6700 000A       104 	beq	PUTSTRING_9
                       105 	/* (7) */
000588 5244            106 	addq	#1, %d4
00058a 5248            107 	addq	#1, %a0
                       108 	/* (8) */
00058c 6000 FFE4       109 	bra LOOP_PUTSTRING	
                       110 PUTSTRING_9:
                       111 	/* (9) */
000590 3C39 00FF       112 	move.w	USTCNT1, %d6
       F900            112 
000596 0046 0004       113 	ori.w	#0x0004, %d6	/* 0xFFFB = 0000000000000100 */
00059a 33C6 00FF       114 	move.w	%d6,	USTCNT1 /* ÈÄÅ‰ø°Ââ≤Ëæº„ÅøË®±ÂèØ */
       F900            114 
                       115 PUTSTRING_10:
                       116 	/* (10) */
0005a0 2004            117 	move.l	%d4, %d0
                       118 End_PUTSTRING:
0005a2 4CDF 017E       119 	movem.l (%sp)+, %d1-%d6/%a0
0005a6 4E75            120 	rts
                       121 ***************************************************************************************************
                       122 
                       123 	
                       124 **********INQ**********************************************************************
                       125 *d0 :„Ç≠„É•„ÉºÁï™Âè∑
                       126 *d1 :8bit„Éá„Éº„Çø
                       127 *Âá∫ÂäõÔºöd0(Â§±Êïó 0/ ÊàêÂäü 1 )
                       128 INQ:
                       129 	/* (1) */
0005a8 40E7            130 	move.w %sr, -(%sp)
0005aa 48E7 3FFE       131 	movem.l %d2-%d7/%a0-%a6,-(%sp) 
                       132 
                       133 	/* (2) */
0005ae 46FC 2700       134 	move.w #0x2700,%sr
                       135 
                       136 	******************************************************************************************
0005b2 43F9 0000       137 	lea.l	Q_INFO, %a1		/* a1: Q_INFO„ÅÆÈñãÂßãÂú∞ÁÇπ */
       0000            137 
0005b8 45F9 0000       138 	lea.l	Q0_START, %a2 		/* a2: Q0„ÅÆÂÖàÈ†≠Áï™Âú∞ */
       0000            138 
0005be 343C 0100       139 	move.w	#B_SIZE, %d2		/* d2: 256 */
0005c2 363C 0014       140 	move.w	#Q_INFO_SIZE, %d3	/* d3: 20 („Ç≠„É•„ÉºÔºëÂÄãÂàÜ„ÅÆÊÉÖÂ†±Èáè) */
                       141 	
0005c6 2800            142 	move.l	%d0,	%d4
0005c8 C8C3            143 	mulu	%d3,	%d4		/* d4 = d0 * Q_INFO_SIZE */
0005ca 2044            144 	move.l	%d4,	%a0
0005cc D1C9            145 	add.l	%a1,	%a0		/* a0 = Q_INFO + d0 * Q_INFO_SIZE(ÂêÑ„Ç≠„É•„ÉºÊÉÖÂ†±„ÅÆÂÖàÈ†≠) */
                       146 	
0005ce 2800            147 	move.l	%d0,	%d4			
0005d0 C8C2            148 	mulu	%d2,	%d4		/* d4 = d0 * B_SIZE */
0005d2 2644            149 	move.l	%d4,	%a3
0005d4 D7CA            150 	add.l	%a2,	%a3		/* a3 = Q0_START + d0 * B_SIZE(ÂêÑ„Ç≠„É•„Éº„ÅÆÂÖàÈ†≠) */
                       151 	******************************************************************************************
                       152 
                       153 	/* (3) */
0005d6 2828 0010       154 	move.l	S_OFS(%a0), %d4
0005da 0C84 0000       155 	cmpi.l	#256, %d4
       0100            155 
0005e0 6700 0006       156 	beq	INQ_Failure
0005e4 6000 0008       157 	bra	INQ_Step1
                       158 INQ_Failure:
0005e8 7000            159 	moveq	#0, %d0
0005ea 6000 0038       160 	bra	END_INQ
                       161 INQ_Step1:
                       162 	/* (4) */
0005ee 2868 0008       163 	move.l	IN_OFS(%a0), %a4
0005f2 1881            164 	move.b	%d1, (%a4)
                       165 
                       166 	/* (5) */
0005f4 2868 0008       167 	movea.l	IN_OFS(%a0), %a4
0005f8 2A68 000C       168 	movea.l	BOTTOM_OFS(%a0), %a5
0005fc BBCC            169 	cmpa.l	%a4, %a5
0005fe 6700 0010       170 	beq	BACK_IN
000602 2868 0008       171 	movea.l	IN_OFS(%a0), %a4
000606 524C            172 	addq	#1, %a4
000608 214C 0008       173 	move.l	%a4, IN_OFS(%a0)
00060c 6000 000A       174 	bra	INQ_Step2
                       175 BACK_IN:
000610 2868 0000       176 	movea.l	TOP_OFS(%a0), %a4
000614 214C 0008       177 	move.l	%a4, IN_OFS(%a0)
                       178 INQ_Step2:
                       179 	/* (6) */
000618 2828 0010       180 	move.l	S_OFS(%a0), %d4
00061c 5284            181 	addq.l	#1, %d4
00061e 2144 0010       182 	move.l	%d4, S_OFS(%a0)
000622 7001            183 	moveq	#1, %d0
                       184 	
                       185 END_INQ:	
                       186 	/* (7) */
000624 4CDF 7FFC       187 	movem.l (%sp)+, %d2-%d7/%a0-%a6
000628 46DF            188 	move.w (%sp)+, %sr
00062a 4E75            189 	rts
                       190 
                       191 ***********************************************************************************
                       192 
                       193 
                       194 **********OUTQ**********************************************************************
                       195 *d0 :„Ç≠„É•„ÉºÁï™Âè∑
                       196 *Âá∫ÂäõÔºëÔºöd0(Â§±Êïó 0/ ÊàêÂäü 1 )
                       197 *Âá∫ÂäõÔºíÔºöd1ÔºàÂèñ„ÇäÂá∫„Åó„Åü8bit„Éá„Éº„ÇøÔºâ
                       198 
                       199 OUTQ:
                       200 	/* (1) */
00062c 40E7            201 	move.w %sr, -(%sp)
00062e 48E7 3FFE       202 	movem.l %d2-%d7/%a0-%a6,-(%sp) 
                       203 
                       204 	/* (2) */
000632 46FC 2700       205 	move.w #0x2700,%sr
                       206 
                       207 	******************************************************************************************
000636 43F9 0000       208 	lea.l	Q_INFO, %a1		/* a1: Q_INFO„ÅÆÈñãÂßãÂú∞ÁÇπ */
       0000            208 
00063c 45F9 0000       209 	lea.l	Q0_START, %a2 		/* a2: Q0„ÅÆÂÖàÈ†≠Áï™Âú∞ */
       0000            209 
000642 343C 0100       210 	move.w	#B_SIZE, %d2		/* d2: 256 */
000646 363C 0014       211 	move.w	#Q_INFO_SIZE, %d3	/* d3: 20 („Ç≠„É•„ÉºÔºëÂÄãÂàÜ„ÅÆÊÉÖÂ†±Èáè) */
                       212 	
00064a 2800            213 	move.l	%d0,	%d4
00064c C8C3            214 	mulu	%d3,	%d4		/* d4 = d0 * Q_INFO_SIZE */
00064e 2044            215 	move.l	%d4,	%a0
000650 D1C9            216 	add.l	%a1,	%a0		/* a0 = Q_INFO + d0 * Q_INFO_SIZE(ÂêÑ„Ç≠„É•„ÉºÊÉÖÂ†±„ÅÆÂÖàÈ†≠) */
                       217 	
000652 2800            218 	move.l	%d0,	%d4			
000654 C8C2            219 	mulu	%d2,	%d4		/* d4 = d0 * B_SIZE */
000656 2644            220 	move.l	%d4,	%a3
000658 D7CA            221 	add.l	%a2,	%a3		/* a3 = Q0_START + d0 * B_SIZE(ÂêÑ„Ç≠„É•„Éº„ÅÆÂÖàÈ†≠) */
                       222 	******************************************************************************************
                       223 
                       224 	/* (3) */
00065a 2828 0010       225 	move.l	S_OFS(%a0), %d4
00065e 0C84 0000       226 	cmpi.l	#0, %d4
       0000            226 
000664 6700 0006       227 	beq	OUTQ_Failure
000668 6000 0008       228 	bra	OUTQ_Step1
                       229 OUTQ_Failure:
00066c 7000            230 	moveq	#0, %d0
00066e 6000 0038       231 	bra	END_OUTQ
                       232 OUTQ_Step1:
                       233 	/* (4) */
000672 2868 0004       234 	move.l	OUT_OFS(%a0), %a4
000676 1214            235 	move.b	(%a4), %d1
                       236 
                       237 	/* (5) */
000678 2868 0004       238 	movea.l	OUT_OFS(%a0), %a4
00067c 2A68 000C       239 	movea.l	BOTTOM_OFS(%a0), %a5
000680 BBCC            240 	cmpa.l	%a4, %a5
000682 6700 0010       241 	beq	BACK_OUT
000686 2868 0004       242 	movea.l	OUT_OFS(%a0), %a4
00068a 524C            243 	addq	#1, %a4
00068c 214C 0004       244 	move.l	%a4, OUT_OFS(%a0)
000690 6000 000A       245 	bra	OUTQ_Step2
                       246 BACK_OUT:
000694 2868 0000       247 	movea.l	TOP_OFS(%a0), %a4
000698 214C 0004       248 	move.l	%a4, OUT_OFS(%a0)
                       249 OUTQ_Step2:
                       250 	/* (6) */
00069c 2828 0010       251 	move.l	S_OFS(%a0), %d4
0006a0 5384            252 	subq.l	#1, %d4
0006a2 2144 0010       253 	move.l	%d4, S_OFS(%a0)
0006a6 7001            254 	moveq	#1, %d0
                       255 	
                       256 END_OUTQ:	
                       257 	/* (7) */
0006a8 4CDF 7FFC       258 	movem.l (%sp)+, %d2-%d7/%a0-%a6
0006ac 46DF            259 	move.w (%sp)+, %sr
0006ae 4E75            260 	rts
                       261 
                       262 ***********************************************************************************
                       263 
                       264 
                       265 	
                       266 .section .data
                       267 ******************************
                       268 ** „Ç≠„É•„ÉºÁî®„ÅÆ„É°„É¢„É™È†òÂüüÁ¢∫‰øù„Å®ÂÆöÊï∞ÂÆöÁæ©
                       269 ******************************
                       270 	.equ	B_SIZE, 	256
                       271 	.equ	B_SIZE_MINUS,	255
                       272 	.equ	Q_NUM,		2
                       273 	
                       274 	.equ	TOP_OFS,	0
                       275 	.equ	OUT_OFS,	4
                       276 	.equ	IN_OFS,		8
                       277 	.equ	BOTTOM_OFS,	12
                       278 	.equ	S_OFS,		16
                       279 	.equ	Q_INFO_SIZE,	20
                       280 
                       281 	.even
000864 0000 0000       282 Q0_START: 	.ds.b	B_SIZE
       0000 0000       282 
       0000 0000       282 
       0000 0000       282 
       0000 0000       282 
000964 0000 0000       283 Q1_START: 	.ds.b	B_SIZE
       0000 0000       283 
       0000 0000       283 
       0000 0000       283 
       0000 0000       283 
                       284 	.even
                       285 Q_INFO:
000a64 0000 0000       286 	.ds.b	Q_INFO_SIZE * Q_NUM
       0000 0000       286 
       0000 0000       286 
       0000 0000       286 
       0000 0000       286 
                       287 
                       288 	
                       289 ******************************
                       290 ** Êõ∏„ÅçËæº„ÇÄ„Éá„Éº„ÇøÔºà„Çµ„É≥„Éó„É´Ôºâ
                       291 ******************************
000a8c 6162 6364       292 Data_to_Que: 	.ascii	"abcdef"		/* Ë™≠„ÅøÊõ∏„Åç„ÉÜ„Çπ„ÉàÁî®„Å´1„Éê„Ç§„ÉàÁ¢∫‰øù */
       6566            292 
                       293 
000a92 0000 0000       294 INQ_Result: .ds.l   300
       0000 0000       294 
       0000 0000       294 
       0000 0000       294 
       0000 0000       294 
000f42 0000 0000       295 OUTQ_Data:  .ds.b   300
       0000 0000       295 
       0000 0000       295 
       0000 0000       295 
       0000 0000       295 
00106e 0000 0000       296 OUTQ_Result:.ds.l   300
       0000 0000       296 
       0000 0000       296 
       0000 0000       296 
       0000 0000       296 
                        82 .include "interget.s"
                        -4 .section .text
                        -3 
                        -2 ***************************
                        -1 ** %d1.l = ch
                         0 ** %d2.b = Âèó‰ø°„Éá„Éº„Çø  data
                         1 ** Êàª„ÇäÂÄ§  „Å™„Åó
                         2 ***************************
                         3 INTERGET:
0006b0 0C81 0000         4 	cmpi.l #0, %d1    /* ch != 0 „Å™„ÇâÁµÇ‰∫Ü */                    
       0000              4 
0006b6 6600 000A         5 	bne INTERGET_END 
0006ba 1202              6 	move.b %d2, %d1   /* %d1 = data */
0006bc 7000              7 	moveq.l #0, %d0   /* „Ç≠„É•„ÉºÁï™Âè∑„Çí 0 „Å´Ë®≠ÂÆö */          
0006be 4EBA FEE8         8 	jsr INQ           /* INQ(0, data) */
                         9 
                        10 INTERGET_END:
0006c2 4E75             11 	rts
                        12 	
                        13 **********************************************
                        14 ** %d1.l = ch
                        15 ** %d2.l = Êõ∏„ÅçËæº„ÅøÂÖà„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ p
                        16 ** %d3.l = Âèñ„ÇäÂá∫„Åô„Éá„Éº„ÇøÊï∞  size
                        17 ** Êàª„ÇäÂÄ§  %d0.l = ÂÆüÈöõ„Å´Âèñ„ÇäÂá∫„Åó„Åü„Éá„Éº„ÇøÊï∞  sz 
                        18 **********************************************
                        19 GETSTRING:
0006c4 48E7 0880        20 	movem.l %d4/%a0, -(%sp)
0006c8 0C81 0000        21 	cmp.l #0, %d1            /* ch != 0 „Å™„ÇâÁµÇ‰∫Ü */                  
       0000             21 
0006ce 6600 0026        22 	bne GETSTRING_END      
0006d2 7800             23 	moveq.l #0, %d4          /* %d4 = 0 , %d4„ÅØ%d0(=sz)„ÅÆ‰∏ÄÊôÇ‰øùÂ≠ò„É¨„Ç∏„Çπ„Çø */                
0006d4 2042             24 	movea.l %d2, %a0         /* %a0 = p */       
                        25 
                        26 GETSTRING_STEP1:
0006d6 B684             27 	cmp.l %d4, %d3           /* %d4 = size „Å™„Çâ STEP2 „Å∏ */               
0006d8 6700 001A        28 	beq GETSTRING_STEP2
0006dc 7000             29 	moveq.l #0, %d0          /* %d0 = 0, „Ç≠„É•„ÉºÁï™Âè∑„Çí0„Å´ */
0006de 4EBA FF4C        30 	jsr OUTQ                 /* OUTQ(0,data) */      
0006e2 0C80 0000        31 	cmpi.l #0, %d0           /* Âæ©Â∏∞ÂÄ§ %d0 „Åå 0 „Å™„Çâ STEP2 „Å∏ */           
       0000             31 
0006e8 6700 000A        32 	beq GETSTRING_STEP2      
0006ec 10C1             33 	move.b %d1, (%a0)+       /* %a0 Áï™Âú∞„Å∏ data „Çí„Ç≥„Éî„Éº, %a0++ */                             
0006ee 5284             34 	addq.l #1, %d4           /* %d4++ */      
0006f0 6000 FFE4        35 	bra GETSTRING_STEP1      
                        36 
                        37 GETSTRING_STEP2:
0006f4 2004             38 	move.l %d4, %d0          /* %d0 = %d4 */  
                        39 
                        40 GETSTRING_END:
0006f6 4CDF 0110        41 	movem.l (%sp)+, %d4/%a0
0006fa 4E75             42 	rts
                        83 .include "timer.s"
                        -4 .section .bss
0058e0 0000 0000        -3 task_p:	.ds.b 4 /*„Çø„Ç§„ÉûÂâ≤„ÇäËæº„Åø„ÅßÂÆüË°å„Åô„Çã„Éó„É≠„Ç∞„É©„É†„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ„ÇíÊ†ºÁ¥ç
                        -2 
                        -1 .section .text
                         0 /*„Çø„Ç§„Éû„É´„Éº„ÉÅ„É≥*/
                         1 RESET_TIMER:
0006fc 33FC 0004         2 	move.w #0x0004, TCTL1
       00FF F600         2 
000704 4E75              3 	rts
                         4 
                         5 SET_TIMER:
000706 23C2 0000         6 	move.l %D2, task_p
       0000              6 
00070c 33FC 00CE         7 	move.w #206, TPRER1 /*„Ç´„Ç¶„É≥„ÇøÂë®Ê≥¢Êï∞„Çí10000„Å´„Åô„Çã-> Âë®Êúü0.1msec*/
       00FF F602         7 
000714 33C1 00FF         8 	move.w %D1, TCMP1
       F604              8 
00071a 33FC 0015         9 	move.w #0x0015, TCTL1 /*ÊØîËºÉÂâ≤„ÇäËæº„ÅøË®±ÂèØ, 1/16Âë®Êúü, „Çø„Ç§„ÉûË®±ÂèØ*/
       00FF F600         9 
000722 4E75             10 	rts
                        11 
                        12 CALL_RP:
000724 2079 0000        13 	movea.l task_p, %A0
       0000             13 
00072a 4E90             14 	jsr  (%A0)
00072c 4E75             15 	rts
                        84 
                        85 	
                        86 uart1_interrupt:
00072e 48E7 FFFE        87     movem.l %D0-%D7/%A0-%A6, -(%SP) | ‰ΩøÁî®„Åô„Çã„É¨„Ç∏„Çπ„Çø„Çí„Çπ„Çø„ÉÉ„ÇØ„Å´‰øùÂ≠ò
000732 3039 00FF        88     move.w UTX1, %D0                | UTX1„ÇíD0„É¨„Ç∏„Çπ„Çø„Å´„Ç≥„Éî„Éº„Åó‰øùÂ≠ò„Åó„Å¶„Åä„Åè
       F906             88 
000738 3200             89     move.w %D0, %D1                 | Ë®àÁÆóÁî®„Å´D1„É¨„Ç∏„Çπ„Çø„Å´„Ç≥„Éî„Éº
00073a E049             90     lsr.w #8, %D1
00073c EE49             91     lsr.w #7, %D1                   | 15ÂõûÂè≥„Ç∑„Éï„ÉàÔºà‰∏ä‰Ωç„Éì„ÉÉ„Éà„ÅØ0Âüã„ÇÅÔºâ
00073e 0C41 0001        92     cmpi.w #1, %D1                  | 0=FIFO„ÅåÁ©∫„Åß„ÅØ„Å™„ÅÑ, 1=Á©∫„Åß„ÅÇ„ÇãÔºàÂâ≤„ÇäËæº„ÅøÁô∫Áîü
000742 6600 0008        93     bne UART1_INTR_SKIP_PUT         | ÈÄÅ‰ø°Ââ≤„ÇäËæº„Åø„Åß„Å™„ÅÑ„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó
000746 7200             94     move.l #0, %D1                  | ch=%D1.L=0
000748 4EBA FDCA        95     jsr INTERPUT
                        96 UART1_INTR_SKIP_PUT:
00074c 3639 00FF        97     move.w URX1, %D3                | Âèó‰ø°„É¨„Ç∏„Çπ„Çø URX1 „Çí %D3.W „Å´„Ç≥„Éî„Éº
       F904             97 
000752 1403             98     move.b %D3, %D2                 | %D3.W „ÅÆ‰∏ã‰Ωç 8bit(„Éá„Éº„ÇøÈÉ®ÂàÜ) „Çí %D2.B „Å´„Ç≥„Éî„Éº
000754 E04B             99     lsr.w #8, %D3
000756 EA4B            100     lsr.w #5, %D3                   | 13ÂõûÂè≥„Ç∑„Éï„ÉàÔºà‰∏ä‰Ωç„Éì„ÉÉ„Éà„ÅØ0Âüã„ÇÅÔºâ
000758 0243 0001       101     and.w #0x1, %D3                 | 0bitÁõÆ‰ª•Â§ñ„Çí0„Å´
00075c 0C43 0001       102     cmpi.w #1, %D3                  | 0 = Âèó‰ø° FIFO „Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÔºé1 = „Éá„Éº„Çø„Åå„ÅÇ„Ç
000760 6600 0008       103     bne UART1_INTR_SKIP_GET
000764 4281            104     clr.l %D1                       | ch = %D1.L = 0, (data = %D2.B„ÅØ‰ª£ÂÖ•Ê∏à)
000766 4EBA FF48       105     jsr INTERGET
                       106 UART1_INTR_SKIP_GET:
00076a 4CDF 7FFF       107     movem.l (%SP)+, %D0-%D7/%A0-%A6 | „É¨„Ç∏„Çπ„Çø„ÇíÂæ©Â∏∞
00076e 4E73            108     rte
                       109 
                       110 tmr1_interrupt:
000770 48E7 FFFE       111     movem.l %D0-%D7/%A0-%A6,-(%SP)  | ‰ΩøÁî®„Åô„Çã„É¨„Ç∏„Çπ„Çø„Çí„Çπ„Çø„ÉÉ„ÇØ„Å´‰øùÂ≠ò
000774 3039 00FF       112     move.w TSTAT1, %D0              | %D0=TSTAT1
       F60A            112 
00077a 0240 0001       113     and.w #0x1, %D0                 | 0bitÁõÆ‰ª•Â§ñ„Çí0„Å´
00077e 0C40 0000       114     cmp.w #0, %D0
000782 6700 000C       115     beq TMR1_END                    | TSTAT1 „ÅÆÁ¨¨ 0 „Éì„ÉÉ„Éà„Åå 1 „Å®„Å™„Å£„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã
000786 4279 00FF       116     clr.w TSTAT1                    | TSTAT1 „Çí 0 „ÇØ„É™„Ç¢
       F60A            116 
00078c 4EBA FF96       117     jsr CALL_RP
                       118 TMR1_END:
000790 4CDF 7FFF       119 	movem.l (%SP)+, %D0-%D7/%A0-%A6 | „É¨„Ç∏„Çπ„Çø„ÇíÂæ©Â∏∞
000794 4E73            120 	rte
                       121 	
                       122 .include "typeren.s"
                        -4 ***************************************************************
                        -3 **ÂêÑÁ®Æ„É¨„Ç∏„Çπ„ÇøÂÆöÁæ©
                        -2 ***************************************************************
                        -1 
                         0 ***************
                         1 ** „É¨„Ç∏„Çπ„ÇøÁæ§„ÅÆÂÖàÈ†≠
                         2 ***************
                         3 .equ REGBASE,   0xFFF000          | DMAP„Çí‰ΩøÁî®Ôºé
                         4 .equ IOBASE,    0x00d00000
                         5 ***************
                         6 ** Ââ≤„ÇäËæº„ÅøÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø
                         7 ***************
                         8 .equ IVR,       REGBASE+0x300     |Ââ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„É¨„Ç∏„Çπ„Çø
                         9 .equ IMR,       REGBASE+0x304     |Ââ≤„ÇäËæº„Åø„Éû„Çπ„ÇØ„É¨„Ç∏„Çπ„Çø
                        10 .equ ISR,       REGBASE+0x30c     |Ââ≤„ÇäËæº„Åø„Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø
                        11 .equ IPR,       REGBASE+0x310     |Ââ≤„ÇäËæº„Åø„Éö„É≥„Éá„Ç£„É≥„Ç∞„É¨„Ç∏„Çπ„Çø
                        12 ***************
                        13 ** „Çø„Ç§„ÉûÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø
                        14 ***************
                        15 .equ TCTL1,     REGBASE+0x600     |„Çø„Ç§„ÉûÔºë„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        16 .equ TPRER1,    REGBASE+0x602     |„Çø„Ç§„ÉûÔºë„Éó„É™„Çπ„Ç±„Éº„É©„É¨„Ç∏„Çπ„Çø
                        17 .equ TCMP1,     REGBASE+0x604     |„Çø„Ç§„ÉûÔºë„Ç≥„É≥„Éö„Ç¢„É¨„Ç∏„Çπ„Çø
                        18 .equ TCN1,      REGBASE+0x608     |„Çø„Ç§„ÉûÔºë„Ç´„Ç¶„É≥„Çø„É¨„Ç∏„Çπ„Çø
                        19 .equ TSTAT1,    REGBASE+0x60a     |„Çø„Ç§„ÉûÔºë„Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø
                        20 ***************
                        21 ** UART1ÔºàÈÄÅÂèó‰ø°ÔºâÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø
                        22 ***************
                        23 .equ USTCNT1,   REGBASE+0x900     | UART1„Çπ„ÉÜ„Éº„Çø„Çπ/„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        24 .equ UBAUD1,    REGBASE+0x902     | UART1„Éú„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        25 .equ URX1,      REGBASE+0x904     | UART1Âèó‰ø°„É¨„Ç∏„Çπ„Çø
                        26 .equ UTX1,      REGBASE+0x906     | UART1ÈÄÅ‰ø°„É¨„Ç∏„Çπ„Çø
                        27 ***************
                        28 ** LED
                        29 ***************
                        30 .equ LED7,      IOBASE+0x000002f  |„Éú„Éº„ÉâÊê≠Ëºâ„ÅÆLEDÁî®„É¨„Ç∏„Çπ„Çø
                        31 .equ LED6,      IOBASE+0x000002d  |‰ΩøÁî®Ê≥ï„Å´„Å§„ÅÑ„Å¶„ÅØ‰ªòÈå≤A.4.3.1
                        32 .equ LED5,      IOBASE+0x000002b
                        33 .equ LED4,      IOBASE+0x0000029
                        34 .equ LED3,      IOBASE+0x000003f
                        35 .equ LED2,      IOBASE+0x000003d
                        36 .equ LED1,      IOBASE+0x000003b
                        37 .equ LED0,      IOBASE+0x0000039
                        38 ***************************************************************
                        39 ** „Çπ„Çø„ÉÉ„ÇØÈ†òÂüü„ÅÆÁ¢∫‰øù
                        40 ***************************************************************
                        41 .section .bss
                        42 .even
                        43 /*SYS_STK:	.ds.b   0x4000  |„Ç∑„Çπ„ÉÜ„É†„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü
                        44 .even
                        45 SYS_STK_TOP:            |„Ç∑„Çπ„ÉÜ„É†„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü„ÅÆÊúÄÂæåÂ∞æ*/
                        46 
                        47 ***************************************************************
                        48 ** ÂàùÊúüÂåñ
                        49 ** ÂÜÖÈÉ®„Éá„Éê„Ç§„Çπ„É¨„Ç∏„Çπ„Çø„Å´„ÅØÁâπÂÆö„ÅÆÂÄ§„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÔºé
                        50 ** „Åù„ÅÆÁêÜÁî±„ÇíÁü•„Çã„Å´„ÅØÔºå‰ªòÈå≤B„Å´„ÅÇ„ÇãÂêÑ„É¨„Ç∏„Çπ„Çø„ÅÆ‰ªïÊßò„ÇíÂèÇÁÖß„Åô„Çã„Åì„Å®Ôºé
                        51 ***************************************************************
                        52 .section .data
00151e 3031 3233        53 	TDATA1: .ascii "0123456789ABCDEF"
       3435 3637        53 
       3839 4142        53 
       4344 4546        53 
00152e 6B6C 6D6E        54 	TDATA2: .ascii "klmnopqrstuvwxyz"
       6F70 7172        54 
       7374 7576        54 
       7778 797A        54 
                        55 ***************************************************************
                        56 ** ÁèæÊÆµÈöé„Åß„ÅÆÂàùÊúüÂåñ„É´„Éº„ÉÅ„É≥„ÅÆÊ≠£Â∏∏Âãï‰Ωú„ÇíÁ¢∫Ë™ç„Åô„Çã„Åü„ÇÅÔºåÊúÄÂæå„Å´‚Äôa‚Äô„Çí
                        57 ** ÈÄÅ‰ø°„É¨„Ç∏„Çπ„ÇøUTX1„Å´Êõ∏„ÅçËæº„ÇÄÔºé'a'„ÅåÂá∫Âäõ„Åï„Çå„Çå„Å∞ÔºåOK.
                        58 ***************************************************************
                        59 .section .text
                        60 .even
                        61 MAIN:
000796 4EBA FD24        62 		jsr Init_Q
00079a 13FC 0031        63 		move.b #'1', LED7
       00D0 002F        63 
                        64 		*move.w #0xe108,USTCNT1
0007a2 46FC 2000        65 		move.w #0x2000, %SR    /* Ëµ∞Ë°å„É¨„Éô„É´0 */
                        66 
                        67 
                        68 PS_TEST1:
                        69 		/* jsr PUTSTRING(0, #TDATA1, 16)*/
0007a6 123C 0000        70 		move.b	#0x00, %d1
0007aa 243C 0000        71 		move.l	#TDATA1, %d2
       0000             71 
0007b0 7610             72 		move.l	#0x10, %d3
0007b2 4EBA FDA6        73 		jsr PUTSTRING
                        74 		
                        75 	
0007b6 13FC 0032        76 		move.b #'2', LED6
       00D0 002D        76 
0007be 283C 000F        77 		move.l	#0x0fffff, %d4
       FFFF             77 
                        78 	
                        79 		
                        80 LOOP:
0007c4 5384             81 		subq.l #1,%d4
0007c6 6700 000E        82 		beq PS_TEST2
0007ca 13FC 0035        83 		move.b #'5', LED3
       00D0 003F        83 
                        84 		
0007d2 6000 FFF0        85 		bra LOOP
                        86 
                        87 PS_TEST2:
0007d6 13FC 0036        88 		move.b #'6', LED2
       00D0 003D        88 
0007de 123C 0000        89 		move.b	#0x00, %d1
0007e2 243C 0000        90 		move.l	#TDATA2, %d2
       0000             90 
0007e8 7610             91 		move.l	#0x10, %d3
0007ea 4EBA FD6E        92 		jsr PUTSTRING
0007ee 6000 FFE6        93 		bra PS_TEST2
                        94 
                        95 /*‰ª•‰∏ã„ÉÜ„Çπ„Éà*/
                        96 TEST_READY:
                        97 		*movem.l %d1-%d5, -(%sp)
                        98 	
0007f2 383C 0010        99 		move.w #16, %d4
0007f6 3A3C 0010       100 		move.w #16, %d5
0007fa 123C 0061       101 		move.b #0x61, %d1
0007fe 6000 0008       102 		bra TEST_LOOP
                       103 
                       104 TEST_LOOP2:
                       105 
000802 5241            106 		addq #1, %d1
000804 383C 0010       107 		move.w #16, %d4
                       108 
                       109 TEST_LOOP:
000808 7001            110 		moveq #1, %d0
                       111 		*move.w #0x1000, %d0
00080a 4EBA FD9C       112 		jsr INQ
                       113 		*jsr OUTQ
00080e 5344            114 		subq #1, %d4
000810 6600 FFF6       115 		bne TEST_LOOP
000814 5345            116 		subq #1, %d5
000816 6700 0006       117 		beq TEST_END
00081a 6000 FFE6       118 		bra TEST_LOOP2
                       119 
                       120 TEST_END:
                       121 		*movem.l (%sp)+, %d1-%d5
00081e 4E75            122 		rts
                       123 /*‰ª•‰∏ä„ÉÜ„Çπ„Éà*/
                       124 
                       125 	
                       126 *************************************************************
                       127 **PUTSTRING
                       128 **ÂÖ•Âäõ
                       129 **d1:„ÉÅ„É£„Éç„É´
                       130 **d2:„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÖà„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ
                       131 **d3:ÈÄÅ‰ø°„Åô„Çã„Éá„Éº„ÇøÊï∞size
                       132 **Êàª„ÇäÂÄ§
                       133 **d0:ÂÆüÈöõ„Å´ÈÄÅ‰ø°„Åó„Åü„Éá„Éº„ÇøÊï∞
                       134 *************************************************************
                       135 
                       136 LOOP_STEP5:
000820 B684            137 	cmp.l %d4,%d3		/*sz=size„ÅßÂàÜÂ≤ê*/
000822 6700 001A       138 	beq PUTSTRING_MASK
                       139 	/* d3 „Å® d4 size = sz „Å™„Çâ„Å∞„Éû„Çπ„ÇØ„Å∏ÁßªÂãï*/
000826 103C 0001       140 	move.b #0x01,%d0 		/*„Ç≠„É•„ÉºÁï™Âè∑„ÅÆË®≠ÂÆö*/
                       141 	/* rv:  INQ„Åå„Éê„Ç§„Éà„Çµ„Ç§„Ç∫„ÅßÊØîËºÉ„Åô„Çã„ÅÆ„ÅßÔΩÇ„Å´Ë®≠ÂÆö*/
00082a 1219            142 	move.b (%a1)+,%d1	/*„Éá„Éº„Çø„ÇíINQ„ÅÆÂÖ•Âäõd1„Å´Ê†ºÁ¥ç*/
                       143 	/* rv: ÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ„Åã„ÇâÈ†Ü„Å´Ê†ºÁ¥ç„Åô„Çã*/
00082c 4EBA FD7A       144 	jsr INQ
000830 0C40 0000       145 	cmp.w #0x00,%d0		/*ÊàêÂäüorÂ§±ÊïóÂà§ÂÆö*/
000834 6700 0008       146 	beq PUTSTRING_MASK
                       147 	/*rv : Â§±Êïó„Å™„Çâ„Å∞„Éû„Çπ„ÇØ„Å∏ÁßªÂãï„Åô„Çã*/
000838 5284            148 	addq.l #0x01,%d4		/*sz++*/
00083a 6000 FFE4       149 	bra LOOP_STEP5
                       150 PUTSTRING_MASK:
00083e 13FC 0037       151 		move.b #'7', LED1
       00D0 003B       151 
                       152 
000846 33FC E10C       153 		move.w #0xe10c, USTCNT1	/*ÈÄÅ‰ø°Ââ≤„ÇäËæº„ÅøË®±ÂèØ*/
       00FF F900       153 
00084e 6000 0002       154 		bra PUTSTRING_END
                       155 
                       156 PUTSTRING_END:
000852 2004            157 		move.l %d4,%d0		/*Êàª„ÇäÂÄ§d0„Å´ÂÆüÈöõ„Å´ÈÄÅ‰ø°„Åó„Åü„Éá„Éº„ÇøÊï∞„ÇíÊ†ºÁ¥ç*/
000854 4CDF 7FF0       158 		movem.l (%SP)+, %a0-%a6/%d4-%d7
                       159 
                       160 		*rte 			/*?*/
                       161 		/* bus errorÂá∫„Åü„ÅÆ„ÅßÂ§âÊõ¥„Åó„Åü*/
                       162 
                       163 		***
000858 13FC 0034       164 		move.b #'4', LED4
       00D0 0029       164 
                       165 		***
000860 4E75            166 		rts
                       167 
                       168 ******************************************************************************:
                       169 
                       170 ******
                       171 ******‰ª•ÈôçQUEUE
                       172 ******
                       173 
                       174 .section .data
                       175 .equ IN_COUNT, 257
                       176 .equ OUT_COUNT, 257
                       177 .equ queue_number, 1
                       178 .equ OFFSET_1, 0x100
                       179 .equ END_0, 0xff
                       180 .equ END_1, 0x1ff
00153e 0000 0000       181 top: .ds.b 0x200
       0000 0000       181 
       0000 0000       181 
       0000 0000       181 
       0000 0000       181 
00173e 0000 0000       182 bottom: .ds.l 1
001742 0000 0000       183 in: .ds.l 1
001746 0000 0000       184 in_0: .ds.l 1
00174a 0000 0000       185 in_1: .ds.l 1
00174e 0000 0000       186 out: .ds.l 1
001752 0000 0000       187 out_0: .ds.l 1
001756 0000 0000       188 out_1: .ds.l 1
00175a 0000 0000       189 s: .ds.l 1
00175e 0000 0000       190 s0: .ds.l 1
001762 0000 0000       191 s1: .ds.l 1
001766 0000 0000       192 START_LABEL: .ds.l 1
                       193 
                       194 *****************************************************************
                       195 **d0:„Ç≠„É•„Éº„ÅÆÈÅ∏Êäû
                       196 **d1:Êõ∏„ÅçËæº„ÇÄ„Éá„Éº„Çø
                       197 **d1:Ëøî„ÇäÂÄ§„ÄÅÊàêÂäüorÂ§±Êïó
                       198 *****************************************************************
                       199 SELECT_QUEUE:
00176a 0C00 0000       200 	cmp.b #0, %d0
00176e 6700 000C       201 	beq SET_0
001772 0C00 0001       202 	cmp.b #1, %d0
001776 6700 003A       203 	beq SET_1
00177a 4E75            204 	rts
                       205 
                       206 SET_0:
00177c 48E7 0030       207 	movem.l %a2-%a3, -(%sp)
001780 23FA FFC4       208 	move.l in_0, in
       0000 0000       208 
001788 23FA FFC8       209 	move.l out_0, out
       0000 0000       209 
001790 45FA FDAC       210 	lea.l top, %a2
001794 23CA 0000       211 	move.l %a2, START_LABEL
       0000            211 
00179a 47EA 00FF       212 	lea.l END_0(%a2), %a3
00179e 23CB 0000       213 	move.l %a3, bottom
       0000            213 
0017a4 23FA FFB8       214 	move.l s0,s
       0000 0000       214 
0017ac 4CDF 0C00       215 	movem.l (%sp)+, %a2-%a3
0017b0 4E75            216 	rts
                       217 
                       218 SET_1:
0017b2 48E7 0030       219 	movem.l %a2-%a3, -(%sp)
0017b6 23FA FF92       220 	move.l in_1, in
       0000 0000       220 
0017be 23FA FF96       221 	move.l out_1, out
       0000 0000       221 
0017c6 45FA FD76       222 	lea.l top, %a2
0017ca 47EA 0100       223 	lea.l OFFSET_1(%a2), %a3
0017ce 23CB 0000       224 	move.l %a3, START_LABEL
       0000            224 
0017d4 47EA 01FF       225 	lea.l END_1(%a2), %a3
0017d8 23CB 0000       226 	move.l %a3, bottom
       0000            226 
0017de 23FA FF82       227 	move.l s1,s
       0000 0000       227 
0017e6 4CDF 0C00       228 	movem.l (%sp)+, %a2-%a3
0017ea 4E75            229 	rts
                       230 
                       231 PUT_BUF:
0017ec 48E7 407E       232 	movem.l %a1-%a6/%d1, -(%sp)
0017f0 243A FF68       233 	move.l s,%d2
0017f4 0C82 0000       234 	cmp.l #0x100,%d2
       0100            234 
0017fa 6700 0038       235 	beq PUT_FAIL
0017fe 49FA FF5A       236 	lea.l s,%a4
001802 5294            237 	addq.l #1,(%a4)
001804 143C 0001       238 	move.b #1,%d2 /*ÊàêÂäü*/
001808 227A FF38       239 	movea.l in, %a1
00180c 12C1            240 	move.b %d1, (%a1)+
00180e 267A FF2E       241 	move.l bottom, %a3
001812 B3CB            242 	cmpa.l %a3, %a1
001814 6300 0008       243 	bls PUT_BUF_STEP1
001818 247A FF4C       244 	move.l START_LABEL, %a2
00181c 224A            245 	movea.l %a2, %a1
                       246 
                       247 PUT_BUF_STEP1:
00181e 23C9 0000       248 	move.l %a1, in
       0000            248 
001824 B3FA FF28       249 	cmpa.l out, %a1
001828 6600 0002       250 	bne PUT_BUF_STEP2
                       251 
                       252 PUT_BUF_STEP2:
00182c 4EBA 0014       253 	jsr UPDATE
001830 6000 000A       254 	bra PUT_BUF_Finish
                       255 
                       256 PUT_FAIL:
001834 343C 0000       257 	move.w #0,%d2 /*Â§±Êïó*/
001838 4EBA 0008       258 	jsr UPDATE
                       259 
                       260 PUT_BUF_Finish:
00183c 4CDF 7E02       261 	movem.l (%sp)+, %a1-%a6/%d1
001840 4E75            262 	rts
                       263 
                       264 UPDATE:
001842 0C00 0000       265 	cmp.b #0, %d0
001846 6700 000C       266 	beq QUEUE_0
00184a 0C00 0001       267 	cmp.b #1, %d0
00184e 6700 001E       268 	beq QUEUE_1
001852 4E75            269 	rts
                       270 
                       271 QUEUE_0:
001854 23C9 0000       272 	move.l %a1, in_0
       0000            272 
00185a 23FA FEF2       273 	move.l out, out_0
       0000 0000       273 
001862 23FA FEF6       274 	move.l s,s0
       0000 0000       274 
00186a 3002            275 	move.w %d2,%d0 /*ÊàêÂäüorÂ§±Êïó„ÅÆËøî„ÇäÂÄ§*/
00186c 4E75            276 	rts
                       277 QUEUE_1:
00186e 23C9 0000       278 	move.l %a1, in_1
       0000            278 
001874 23FA FED8       279 	move.l out, out_1
       0000 0000       279 
00187c 23FA FEDC       280 	move.l s,s1
       0000 0000       280 
001884 3002            281 	move.w %d2,%d0 /*ÊàêÂäüorÂ§±Êïó„ÅÆËøî„ÇäÂÄ§*/
001886 4E75            282 	rts
                       283 
                       284 ********************************************
                       285 **d0:„Ç≠„É•„Éº„ÅÆÈÅ∏Êäû
                       286 **d1:Êàª„ÇäÂÄ§„ÄÅÂèñ„ÇäÂá∫„Åó„Åü„Éá„Éº„Çø
                       287 ********************************************
                       288 GET_BUF:
001888 48E7 007E       289 	movem.l %a1-%a6, -(%sp)
00188c 243A FECC       290 	move.l s,%d2
001890 0C82 0000       291 	cmp.l #0x00,%d2
       0000            291 
001896 6700 0038       292 	beq GET_FAIL
00189a 143C 0001       293 	move.b #1,%d2 /*ÊàêÂäü*/
00189e 49FA FEBA       294 	lea.l s,%a4
0018a2 5394            295 	subq.l #1,(%a4)
0018a4 227A FEA8       296 	movea.l out, %a1
0018a8 1219            297 	move.b (%a1)+, %d1
0018aa 267A FE92       298 	move.l bottom, %a3
0018ae B3CB            299 	cmpa.l %a3, %a1
0018b0 6300 0008       300 	bls GET_BUF_STEP1
0018b4 247A FEB0       301 	move.l START_LABEL, %a2
0018b8 224A            302 	movea.l %a2, %a1
                       303 
                       304 GET_BUF_STEP1:
0018ba 23C9 0000       305 	move.l %a1, out
       0000            305 
0018c0 B3FA FE80       306 	cmpa.l in, %a1
0018c4 6600 0002       307 	bne GET_BUF_STEP2
                       308 
                       309 GET_BUF_STEP2:
0018c8 4EBA FF78       310 	jsr UPDATE
0018cc 6000 000A       311 	bra GET_BUF_Finish
                       312 
                       313 GET_FAIL:
0018d0 343C 0000       314 	move.w #0,%d2 /*Â§±Êïó*/
0018d4 4EBA FF6C       315 	jsr UPDATE
                       316 *move.w #0x0800+'e', UTX1
                       317 
                       318 GET_BUF_Finish:
0018d8 4CDF 7E00       319 	movem.l (%sp)+, %a1-%a6
0018dc 4E75            320 	rts
                       321 
                       322 
                       323 
                       324 
                       325 
                       326 
                       327 
                       328 
                       123 .end

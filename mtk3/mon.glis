68K GAS  mon.s 			page 1


   1               	.include "defs.s"
   1               	/* „É¨„Ç∏„Çπ„ÇøÂÆöÁæ© */
   2               	.equ REGBASE, 0xfff000 | DMAP „Çí‰ΩøÁî®Ôºé
   3               	.equ IOBASE, 0x00d00000
   4               	
   5               	/* Ââ≤„ÇäËæº„ÅøÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø*/
   6               	.equ IVR, REGBASE+0x300 | Ââ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„É¨„Ç∏„Çπ„Çø
   7               	.equ IMR, REGBASE+0x304 | Ââ≤„ÇäËæº„Åø„Éû„Çπ„ÇØ„É¨„Ç∏„Çπ„Çø
   8               	.equ ISR, REGBASE+0x30c | Ââ≤„ÇäËæº„Åø„Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø
   9               	.equ IPR, REGBASE+0x310 | Ââ≤„ÇäËæº„Åø„Éö„É≥„Éá„Ç£„É≥„Ç∞„É¨„Ç∏„Çπ„Çø
  10               	
  11               	/* „Çø„Ç§„ÉûÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø */
  12               	.equ TCTL1, REGBASE+0x600  | „Çø„Ç§„ÉûÔºë„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
  13               	.equ TPRER1, REGBASE+0x602 | „Çø„Ç§„ÉûÔºë„Éó„É™„Çπ„Ç±„Éº„É©„É¨„Ç∏„Çπ„Çø
  14               	.equ TCMP1, REGBASE+0x604  | „Çø„Ç§„ÉûÔºë„Ç≥„É≥„Éö„Ç¢„É¨„Ç∏„Çπ„Çø
  15               	.equ TCN1, REGBASE+0x608   | „Çø„Ç§„ÉûÔºë„Ç´„Ç¶„É≥„Çø„É¨„Ç∏„Çπ„Çø
  16               	.equ TSTAT1, REGBASE+0x60a | „Çø„Ç§„ÉûÔºë„Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø
  17               	
  18               	/* UART1ÔºàÈÄÅÂèó‰ø°ÔºâÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø */
  19               	.equ USTCNT1, REGBASE+0x900 | UART1 „Çπ„ÉÜ„Éº„Çø„Çπ/„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
  20               	.equ UBAUD1, REGBASE+0x902  | UART1 „Éú„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
  21               	.equ URX1, REGBASE+0x904    | UART1 Âèó‰ø°„É¨„Ç∏„Çπ„Çø
  22               	.equ UTX1, REGBASE+0x906    | UART1 ÈÄÅ‰ø°„É¨„Ç∏„Çπ„Çø
  23               	
  24               	/* UART2ÔºàÈÄÅÂèó‰ø°ÔºâÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø */
  25               	.equ USTCNT2, REGBASE+0x910 | UART2 „Çπ„ÉÜ„Éº„Çø„Çπ/„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
  26               	.equ UBAUD2, REGBASE+0x912  | UART2 „Éú„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
  27               	.equ URX2, REGBASE+0x914    | UART2 Âèó‰ø°„É¨„Ç∏„Çπ„Çø
  28               	.equ UTX2, REGBASE+0x916    | UART2 ÈÄÅ‰ø°„É¨„Ç∏„Çπ„Çø
  29               	
  30               	/* LED */
  31               	/*„Åì„Åì„ÅßÊåáÂÆö„Åï„Çå„Åü„Ç¢„Éâ„É¨„Çπ„Å´Ë°®Á§∫„Åï„Åõ„Åü„ÅÑÊñáÂ≠ó„Ç≥„Éº„Éâ„ÇíÂÖ•„Çå„Çã„Åì„Å®„ÅßLEDË
  32               	.equ LED7, IOBASE+0x000002f | „Éú„Éº„ÉâÊê≠Ëºâ„ÅÆ LED Áî®„É¨„Ç∏„Çπ„Çø
  33               	.equ LED6, IOBASE+0x000002d 
  34               	.equ LED5, IOBASE+0x000002b
  35               	.equ LED4, IOBASE+0x0000029
  36               	.equ LED3, IOBASE+0x000003f
  37               	.equ LED2, IOBASE+0x000003d
  38               	.equ LED1, IOBASE+0x000003b
  39               	.equ LED0, IOBASE+0x0000039
  40               	
  41               	/*D0„ÅÆÂÄ§„ÅßÂëº„Å≥Âá∫„Åô„Çµ„Éñ„É´„Éº„ÉÅ„É≥„ÇíÊ±∫„ÇÅ„Å¶„ÅÑ„Çã„ÄÇ„Åì„Åì„Åß„ÅØ‰Ωï„ÇíÂëº„Å≥Âá∫„Åó„Å¶„Å
  42               	.equ SYSCALL_NUM_GETSTRING,   1 |ÊñáÂ≠óÂàóÂÖ•ÂäõÔºàGETSTRINGÔºâÔºà„Åì„Åì„Åã„Çâ„Ç≥„É°„É≥„ÉàÈ¥ª‰∏äÔºâ
  43               	.equ SYSCALL_NUM_PUTSTRING,   2 |ÊñáÂ≠óÂàóÂá∫Âäõ(PUTSTRING)|
  44               	.equ SYSCALL_NUM_RESET_TIMER, 3 |„Çø„Ç§„Éû„É™„Çª„ÉÉ„Éà|
  45               	.equ SYSCALL_NUM_SET_TIMER,   4 |„Çø„Ç§„Éû„Çª„ÉÉ„Éà|
  46               	.equ SYSCALL_NUM_SKIPMT, 5
   2               	
   3               	/* „Çπ„Çø„ÉÉ„ÇØ */
   4               	.section .bss
   5               	.even
   6 0000 0000 0000 	SYS_STK:.ds.b 0x4000
   6      0000 0000 
   6      0000 0000 
   6      0000 0000 
   6      0000 0000 
   7               	.even
68K GAS  mon.s 			page 2


   8               	SYS_STK_TOP: | „Ç∑„Çπ„ÉÜ„É†„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü„ÅÆÊúÄÂæåÂ∞æ
   9               	
  10               	/* ÂàùÊúüÂåñ */
  11               	.section .text
  12               	.even
  13               	.extern start
  14               	.global monitor_begin
  15               	monitor_begin:
  16               	boot:
  17 0000 46FC 2700 	    move.w #0x2700, %SR     | Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢
  18 0004 4FF9 0000 	    lea.l SYS_STK_TOP, %SP  | „Çπ„Çø„ÉÉ„ÇØ„Éù„Ç§„É≥„Çø„ÅÆË®≠ÂÆö
  18      0000 
  19               	
  20               	    /* Ââ≤„ÇäËæº„Åø„Ç≥„É≥„Éà„É≠„Éº„É©„ÅÆÂàùÊúüÂåñ */
  21 000a 13FC 0040 	    move.b #0x40, IVR       | „É¶„Éº„Ç∂Ââ≤„ÇäËæº„Åø„Éô„ÇØ„ÇøÁï™Âè∑„Çí0x40*4(=0x100)+level„Å´Ë®≠ÂÆö
  21      00FF F300 
  22 0012 23FC 00FF 	    move.l #0x00ffffff, IMR | ÂÖ®Ââ≤„ÇäËæº„Åø„Éû„Çπ„ÇØ
  22      FFFF 00FF 
  22      F304 
  23               	
  24 001c 21FC 0000 	    move.l #syscall_handler, 0x080 | TRAP#0„ÅÆÂâ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÇíÁôªÈå≤
  24      0000 0080 
  25 0024 21FC 0000 	    move.l #uart1_interrupt, 0x110 | UART1„ÅÆÂâ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÇíÁôªÈå≤
  25      0000 0110 
  26 002c 21FC 0000 	    move.l #uart2_interrupt, 0x114 | UART2„ÅÆÂâ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÇíÁôªÈå≤  
  26      0000 0114 
  27 0034 21FC 0000 	    move.l #tmr1_interrupt, 0x118  | TIMER1„ÅÆÂâ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÇíÁôªÈå≤
  27      0000 0118 
  28               	
  29               	    /* ÈÄÅÂèó‰ø° (UART1) Èñ¢‰øÇ„ÅÆÂàùÊúüÂåñ (Ââ≤„ÇäËæº„Åø„É¨„Éô„É´„ÅØ 4 „Å´Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã) *
  30 003c 33FC 0000 	    move.w #0x0000, USTCNT1   | „É™„Çª„ÉÉ„Éà
  30      00FF F900 
  31               	    * move.w #0xe100, USTCNT1 | ÈÄÅÂèó‰ø°ÂèØËÉΩ, „Éë„É™„ÉÜ„Ç£„Å™„Åó, 1 stop, 8 bit, ÈÄÅÂèóÂâ≤„ÇäËæº
  32 0044 33FC E108 	    move.w #0xe108, USTCNT1   | Âèó‰ø°Ââ≤„ÇäËæº„ÅøÂèØËÉΩ
  32      00FF F900 
  33               	    * move.w #0xe104, USTCNT1 | ÈÄÅ‰ø°Ââ≤„ÇäËæº„ÅøÂèØËÉΩ
  34 004c 33FC 0038 	    move.w #0x0038, UBAUD1    | baud rate = 230400 bps
  34      00FF F902 
  35               	    
  36               	    /* ÈÄÅÂèó‰ø° (UART2) Èñ¢‰øÇ„ÅÆÂàùÊúüÂåñ (Ââ≤„ÇäËæº„Åø„É¨„Éô„É´„ÅØ 4 „Å´Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã) *
  37 0054 33FC 0000 	    move.w #0x0000, USTCNT2    | „É™„Çª„ÉÉ„Éà
  37      00FF F910 
  38               	    * move.w #0xe100, USTCNT2  | ÈÄÅÂèó‰ø°ÂèØËÉΩ, „Éë„É™„ÉÜ„Ç£„Å™„Åó, 1 stop, 8 bit, ÈÄÅÂèóÂâ≤„ÇäËæ
  39 005c 33FC E108 	    move.w #0xe108, USTCNT2    | Âèó‰ø°Ââ≤„ÇäËæº„ÅøÂèØËÉΩ
  39      00FF F910 
  40               	    * move.w #0xe104, USTCNT2  | ÈÄÅ‰ø°Ââ≤„ÇäËæº„ÅøÂèØËÉΩ
  41 0064 33FC 0038 	    move.w #0x0038, UBAUD2     | baud rate = 230400 bps
  41      00FF F912 
  42               	
  43               	    /* „Çø„Ç§„ÉûÈñ¢‰øÇ„ÅÆÂàùÊúüÂåñ (Ââ≤„ÇäËæº„Åø„É¨„Éô„É´„ÅØ 6 „Å´Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã) */
  44 006c 33FC 0004 	    move.w #0x0004, TCTL1   | restart, Ââ≤„ÇäËæº„Åø‰∏çÂèØ,
  44      00FF F600 
  45               	                            | „Ç∑„Çπ„ÉÜ„É†„ÇØ„É≠„ÉÉ„ÇØ„ÅÆ 1/16 „ÇíÂçò‰Ωç„Å®„Åó„Å¶Ë®àÊôÇÔºå
  46               	                            | „Çø„Ç§„Éû‰ΩøÁî®ÂÅúÊ≠¢
  47               	
  48 0074 4EBA 013E 	    jsr	Init_Q            | „Ç≠„É•„Éº„ÅÆÂàùÊúüÂåñ
  49               	
68K GAS  mon.s 			page 3


  50               	    * move.l #0xff3ffb, IMR | UART1„ÅÆÂâ≤„ÇäËæº„Åø„ÇíË®±ÂèØ
  51               	    * move.l #0xff3ff9, IMR | UART1,TIMER„ÅÆÂâ≤„ÇäËæº„Åø„ÇíË®±ÂèØ
  52 0078 23FC 00FF 	    move.l #0xff2ff9, IMR
  52      2FF9 00FF 
  52      F304 
  53 0082 46FC 2000 	    move.w #0x2000, %SR   | „Çπ„Éº„Éë„Éº„Éê„Ç§„Ç∂„É¢„Éº„Éâ„ÉªËµ∞Ë°å„É¨„Éô„É´„ÅØ0
  54 0086 4EF9 0000 	    jmp start
  54      0000 
  55               	    * bra MAIN
  56               	
  57               	
  58               	****************************************************************
  59               	*** ÂàùÊúüÂÄ§„ÅÆÁÑ°„ÅÑ„Éá„Éº„ÇøÈ†òÂüü
  60               	****************************************************************
  61               	.section .bss
  62               	BUF:
  63 4000 0000 0000 	    .ds.b 256 | BUF[256]
  63      0000 0000 
  63      0000 0000 
  63      0000 0000 
  63      0000 0000 
  64               	    .even
  65               	USR_STK:
  66 4100 0000 0000 	    .ds.b 0x4000 | „É¶„Éº„Ç∂„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü
  66      0000 0000 
  66      0000 0000 
  66      0000 0000 
  66      0000 0000 
  67               	    .even
  68               	USR_STK_TOP:     | „É¶„Éº„Ç∂„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü„ÅÆÊúÄÂæåÂ∞æ
  69               	******************************************************************
  70               	/*; ---- end include main.s ----*/
  71               	
  72               	
  73               	/* Ââ≤„ÇäËæº„Åø„Éè„É≥„Éâ„É© */
  74               	/* ---- begin include syscall.s ---- */
  75               	
  76               	.section .text
  77               	/*D0„ÅÆÂÄ§„ÅßÂëº„Å≥Âá∫„Åô„Çµ„Éñ„É´„Éº„ÉÅ„É≥„ÇíÊ±∫„ÇÅ„Å¶„ÅÑ„Çã„ÄÇ„Åì„Åì„Åß„ÅØ‰Ωï„ÇíÂëº„Å≥Âá∫„Åó„Å¶„Å
  78               	.equ SYSCALL_NUM_GETSTRING,   1 |ÊñáÂ≠óÂàóÂÖ•ÂäõÔºàGETSTRINGÔºâÔºà„Åì„Åì„Åã„Çâ„Ç≥„É°„É≥„ÉàÈ¥ª‰∏äÔºâ
  79               	.equ SYSCALL_NUM_PUTSTRING,   2 |ÊñáÂ≠óÂàóÂá∫Âäõ(PUTSTRING)|
  80               	.equ SYSCALL_NUM_RESET_TIMER, 3 |„Çø„Ç§„Éû„É™„Çª„ÉÉ„Éà|
  81               	.equ SYSCALL_NUM_SET_TIMER,   4 |„Çø„Ç§„Éû„Çª„ÉÉ„Éà|
  82               	.equ SYSCALL_NUM_SKIPMT,      5 |SKIPMT
  83               	/*
  84               	 * syscall_handler
  85               	 * %d0: syscall number
  86               	 * %dx: syscall argument
  87               		*/
  88               	******************************************
  89               	**syscall_handler„ÅØTRAP #0„Å´„Çà„ÇäÂëº„Å≥„Å†„Åï„Çå„Çã„Ç∑„Çπ„ÉÜ„É†„Ç≥„Éº„É´ÂÖ±ÈÄö„Éè„É≥„Éâ„É©ÔºàÈ¥ª
  90               	**D0„É¨„Ç∏„Çπ„Çø„ÅÆÂÄ§„Å´„Çà„Å£„Å¶„Å©„ÅÆ„Çµ„Éñ„É´„Éº„ÉÅ„É≥„Çí„Çà„Å∂„Åã„ÇíÂàÜÂ≤ê„Åô„Çã
  91               	**ÂÖ•ÂäõD0.l :„Ç∑„Çπ„ÉÜ„É†„Ç≥„Éº„É´Áï™Âè∑Ôºà‰∏äË®òÂÆöÁæ©„ÅÆ„ÅÑ„Å•„Çå„ÅãÔºâ
  92               	**D1~D7/A0~A6:ÂêÑ„Ç∑„Çπ„ÉÜ„É†„Ç≥„Éº„É´„Å´Âøú„Åò„ÅüÂºïÊï∞
  93               	**Âá∫Âäõ
  94               	**ÂøÖË¶Å„Å´Âøú„Åò„Å¶D0„Å´Êàª„ÇäÂÄ§„ÇíÊ†ºÁ¥çÔºàÈ¥ª‰∏äÔºâ
  95               	*****************************************	
68K GAS  mon.s 			page 4


  96               		
  97               	syscall_handler:
  98 008c 0C80 0000 	        cmpi.l #SYSCALL_NUM_SKIPMT, %D0
  98      0005 
  99 0092 6700 0336 	        beq tmr1_interrupt
 100               	
 101 0096 48E7 7FFE 		movem.l %D1-%D7/%A0-%A6, -(%SP)
 102 009a 0C80 0000 		cmpi.l #SYSCALL_NUM_GETSTRING, %D0   |D0==1?ÔºàÈ¥ª‰∏äÔºâ|
 102      0001 
 103 00a0 6700 0026 		beq CALL_GETSTRING                   |‚ÜíGETSTRINGÂá¶ÁêÜ„Å∏|
 104               	
 105 00a4 0C80 0000 		cmpi.l #SYSCALL_NUM_PUTSTRING, %D0   |D0==2?|
 105      0002 
 106 00aa 6700 0024 		beq CALL_PUTSTRING                   |‚ÜíPUTSTRINGÂá¶ÁêÜ„Å∏|
 107 00ae 0C80 0000 		cmpi.l #SYSCALL_NUM_RESET_TIMER, %D0 |D0==3?|
 107      0003 
 108 00b4 6700 0022 		beq CALL_RESET_TIMER                 |RESET_TIMERÂá¶ÁêÜ„Å∏|
 109 00b8 0C80 0000 		cmpi.l #SYSCALL_NUM_SET_TIMER, %D0   |D0==4?|
 109      0004 
 110 00be 6700 0020 		beq CALL_SET_TIMER                   |CALL_SET_TIMERÂá¶ÁêÜ„Å∏|
 111               	**********************
 112               	** „ÅÑ„Åö„Çå„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Ç≥„Éº„É´Áï™Âè∑„Å´„ÇÇË©≤ÂΩì„Åó„Å™„ÅÑ
 113               	**********************	
 114               	END_SYSCALL_HNDR:
 115 00c2 4CDF 7FFE 	    movem.l (%SP)+, %D1-%D7/%A0-%A6
 116 00c6 4E73      		rte
 117               	**********
 118               	**ÂêÑ„Ç∑„Çπ„ÉÜ„É†„Ç≥„Éº„É´Âá¶ÁêÜ„ÅÆÂàÜÂ≤êÂÖà
 119               	*********	
 120               	/*ÂêÑ„Çµ„Éñ„É´„Éº„ÉÅ„É≥„ÇíÂëº„Å≥Âá∫„Åô„Åü„ÇÅ„ÅÆÂ†¥ÊâÄ„ÄÅ„Çµ„Éñ„É´„Éº„ÉÅ„É≥ÂëºÂá∫„ÅóÂæå„ÅØ„Ç∑„Çπ„ÉÜ„
 121               	CALL_GETSTRING:
 122 00c8 4EBA 01FE 		jsr GETSTRING
 123 00cc 6000 FFF4 		bra END_SYSCALL_HNDR
 124               	
 125               	CALL_PUTSTRING:
 126 00d0 4EBA 007A 		jsr PUTSTRING
 127 00d4 6000 FFEC 		bra END_SYSCALL_HNDR
 128               		
 129               	CALL_RESET_TIMER:
 130 00d8 4EBA 023A 		jsr RESET_TIMER
 131 00dc 6000 FFE4 		bra END_SYSCALL_HNDR
 132               	CALL_SET_TIMER:
 133 00e0 4EBA 023C 		jsr SET_TIMER
 134 00e4 6000 FFDC 		bra END_SYSCALL_HNDR
 135               	/*; ---- end include syscall.s ----*/
 136               	
 137               	/* ---- begin include queue.s ---- */
 138               	.section .text
 139               	
 140               	
 141               	******INTERPUT*************************************************************************************
 142               	** ÂÖ•ÂäõÔºöd1.lÔºà„ÉÅ„É£„É≥„Éç„É´Ôºâ
 143               	** „ÉÅ„É£„Éç„É´ ch „ÅÆÈÄÅ‰ø°„Ç≠„É•„Éº„Åã„Çâ„Éá„Éº„Çø„Çí‰∏Ä„Å§Âèñ„ÇäÂá∫„ÅóÔºåÂÆüÈöõ„Å´ÈÄÅ‰ø°	
 144               	INTERPUT:
 145 00e8 48E7 E0C0 		movem.l %d0-%d2/%a0-%a1,-(%sp)
 146               		
 147               		/* (1) */
68K GAS  mon.s 			page 5


 148 00ec 46FC 2700 		move.w  #0x2700, %sr
 149               		/* (2) */
 150 00f0 0C81 0000 		cmpi.l #0, %d1
 150      0000 
 151 00f6 6700 0010 		beq INTERPUT_CH0
 152 00fa 0C81 0000 		cmpi.l #1, %d1
 152      0001 
 153 0100 6700 0018 		beq INTERPUT_CH1
 154 0104 6000 0040 		bra End_INTERPUT		|ch=0,1‰ª•Â§ñ„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
 155               	INTERPUT_CH0:	
 156               		/* (3) */
 157 0108 7001      		moveq	#1, %d0
 158 010a 41F9 00FF 		lea.l UTX1, %a0
 158      F906 
 159 0110 43F9 00FF 		lea.l USTCNT1, %a1
 159      F900 
 160 0116 6000 0010 		bra INTERPUT_COMMON
 161               	INTERPUT_CH1:
 162 011a 7003      		moveq	#3, %d0
 163 011c 41F9 00FF 		lea.l UTX2, %a0
 163      F916 
 164 0122 43F9 00FF 		lea.l USTCNT2, %a1
 164      F910 
 165               	INTERPUT_COMMON:
 166 0128 4EBA 0120 		jsr	OUTQ			|ÈÄÅ‰ø°„Ç≠„É•„Éº„Åã„Çâ„Éá„Éº„Çø„Çí‰∏Ä„Å§Âèñ„ÇäÂá∫„Åó
 167               		*Âá∫ÂäõÔºëÔºöd0(Â§±Êïó 0/ ÊàêÂäü 1 )
 168               		*Âá∫ÂäõÔºíÔºöd1ÔºàÂèñ„ÇäÂá∫„Åó„Åü8bit„Éá„Éº„ÇøÔºâ
 169               		/* (4) */
 170 012c 0C40 0000 		cmpi #0, %d0
 171 0130 6700 000C 		beq INTERPUT_MASK		|Âèñ„ÇäÂá∫„ÅóÂ§±Êïó„Å™„Çâ„ÄÅÈÄÅ‰ø°Ââ≤„ÇäËæº„Åø„Çí„Éû„Çπ„ÇØÔºàÁ¶ÅÊ≠¢Ôºâ
 172               		/* (5) */
 173               		/* d1„ÇíUTX1„Å´‰ª£ÂÖ•Ôºà‰∏ã‰ΩçÔºòbitÔºâ */
 174 0134 0041 0800 		ori #0x0800, %d1                | „Éò„ÉÉ„ÉÄ„Çí‰ª£ÂÖ•
 175 0138 3081      		move.w %d1, (%a0)               | ÈÄÅ‰ø°
 176 013a 6000 000A 		bra End_INTERPUT
 177               	INTERPUT_MASK:
 178               		/* (4)' */		|ÈÄÅ‰ø°Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÄÅÈÄÅ‰ø°Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢
 179 013e 3411      		move.w	(%a1), %d2
 180 0140 0242 FFFB 		andi.w	#0xFFFB, %d2	| 0xFFFB = 1111111111111011 
 181 0144 3282      		move.w	%d2, (%a1)    | USTCNT1„ÅÆTXEE„Çí0„Å´„Åô„Çã 
 182               	End_INTERPUT:
 183 0146 4CDF 0307 		movem.l (%sp)+, %d0-%d2/%a0-%a1
 184 014a 4E75      		rts
 185               	***************************************************************************************************
 186               	
 187               	*********PUTSTRING*********************************************************************************
 188               	** „Éá„Éº„Çø„ÇíÈÄÅ‰ø°„Ç≠„É•„Éº„Å´Ê†ºÁ¥ç„ÅóÔºåÈÄÅ‰ø°Ââ≤„ÇäËæº„Åø„ÇíÈñãÂßã	
 189               	** ÂÖ•ÂäõÔºëÔºö„ÉÅ„É£„Éç„É´ ch ‚Üí %D1.L
 190               	** ÂÖ•ÂäõÔºíÔºö„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÖà„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ p ‚Üí %D2.L
 191               	** ÂÖ•ÂäõÔºìÔºöÈÄÅ‰ø°„Åô„Çã„Éá„Éº„ÇøÊï∞ size ‚Üí %D3.L
 192               	** Âá∫Âäõ  ÔºöÂÆüÈöõ„Å´ÈÄÅ‰ø°„Åó„Åü„Éá„Éº„ÇøÊï∞ sz ‚Üí %D0.L
 193               		
 194               	PUTSTRING:
 195 014c 48E7 7EC0 		movem.l %d1-%d6/%a0-%a1,-(%sp)
 196               		/* (1) */
 197 0150 0C81 0000 		cmpi.l #0, %d1		
 197      0000 
68K GAS  mon.s 			page 6


 198 0156 6700 0010 		beq PUTSTRING_CH0
 199 015a 0C81 0000 		cmpi.l #1, %d1
 199      0001 
 200 0160 6700 0012 		beq PUTSTRING_CH1
 201 0164 6000 0048 		bra	End_PUTSTRING	| ch=0,1‰ª•Â§ñ„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
 202               	PUTSTRING_CH0:
 203 0168 7001      	        moveq #1, %d0
 204 016a 43F9 00FF 		lea.l USTCNT1, %a1
 204      F900 
 205 0170 6000 000A 		bra PUTSTRING_COMMON
 206               	PUTSTRING_CH1:
 207 0174 7003      	        moveq #3, %d0
 208 0176 43F9 00FF 		lea.l USTCNT2, %a1
 208      F910 
 209               	PUTSTRING_COMMON:
 210               		/* (2) */
 211 017c 7800      		moveq	#0, %d4  	| d4 = sz = 0 
 212 017e 2042      		movea.l	%d2, %a0 	| a0 = i = p 
 213               		/* (3) */
 214 0180 0C43 0000 		cmpi 	#0, %d3		| ÈÄÅ‰ø°„Çµ„Ç§„Ç∫„ÅåÔºê„ÅÆ„Å®„Åç
 215 0184 6700 0026 		beq	PUTSTRING_10
 216               	LOOP_PUTSTRING:	
 217               		/* (4) */
 218 0188 B843      		cmp	%d3, %d4	| ÈÄÅ‰ø°„Çµ„Ç§„Ç∫ == ÈÄÅ‰ø°„Åó„ÅüÊï∞Ôºü
 219 018a 6700 0018 		beq	PUTSTRING_9
 220               		/* (5) */
 221 018e 1210      		move.b	(%a0), %d1	| a0:„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÖà„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ
 222 0190 4EBA 0064 		jsr	INQ
 223               		*d0 :„Ç≠„É•„ÉºÁï™Âè∑
 224               		*d1 :8bit„Éá„Éº„Çø
 225               		*Âá∫ÂäõÔºöd0(Â§±Êïó 0/ ÊàêÂäü 1 )
 226               		/* (6) */
 227 0194 0C40 0000 		cmpi 	#0, %d0		| INQÂ§±ÊïóÔºü
 228 0198 6700 000A 		beq	PUTSTRING_9	
 229               		/* (7) */
 230 019c 5244      		addq	#1, %d4		| ÈÄÅ‰ø°„Åó„ÅüÊï∞„Å´Ôºë„ÇíË∂≥„Åô
 231 019e 5248      		addq	#1, %a0		| Ë™≠„ÅøËæº„ÇÄ„Éá„Éº„Çø„ÇíÊ¨°„Å´
 232               		/* (8) */
 233 01a0 6000 FFE6 		bra 	LOOP_PUTSTRING | ÂÖ®„Å¶ÈÄÅ‰ø° or INQÂ§±Êïó„Åæ„ÅßÁ∂ö„Åë„Çã
 234               	PUTSTRING_9:
 235               		/* (9) */
 236 01a4 3C11      		move.w	(%a1), %d6
 237 01a6 0046 0004 		ori.w	#0x0004, %d6	| 0xFFFB = 0000000000000100 
 238 01aa 3286      		move.w	%d6, (%a1)      | ÈÄÅ‰ø°Ââ≤Ëæº„ÅøË®±ÂèØ 
 239               	PUTSTRING_10:
 240               		/* (10) */
 241 01ac 2004      		move.l	%d4, %d0	| d0(Âá∫Âäõ) = sz(ÈÄÅ‰ø°„Åó„ÅüÊï∞)
 242               	End_PUTSTRING:
 243 01ae 4CDF 037E 		movem.l (%sp)+, %d1-%d6/%a0-%a1
 244 01b2 4E75      		rts
 245               		
 246               	***************************************************************************************************
 247               	*****************************
 248               	** „Ç≠„É•„ÉºÊßãÈÄ†‰ΩìÂÆöÁæ©
 249               	******************************
 250               	.equ Q_SIZE, 256              
 251               	.equ Q_COUNT, 4               
68K GAS  mon.s 			page 7


 252               	.equ top_ofs,     Q_SIZE     
 253               	.equ bottom_ofs,  Q_SIZE+4
 254               	.equ out_ofs,     Q_SIZE+8
 255               	.equ in_ofs,      Q_SIZE+12
 256               	.equ s_ofs,       Q_SIZE+16
 257               	.equ Q_STRIDE,    Q_SIZE+20 |„Ç≠„É•„ÉºÊßãÈÄ†‰Ωì„ÅÆÂÖ®Èï∑
 258               	**********************
 259               	** „Ç≠„É•„Éº„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ
 260               	**********************
 261               	Init_Q:
 262 01b4 48E7 C0C0 		movem.l	%d0-%d1/%a0-%a1,-(%sp)
 263 01b8 7004      		moveq #Q_COUNT, %d0
 264 01ba 5340      		subq #1, %d0
 265 01bc 41F9 0000 		lea.l QUEUE0, %a0 | %a0 = QUEUE0„ÅÆÈñãÂßã„Ç¢„Éâ„É¨„Çπ
 265      0000 
 266 01c2 223C 0000 		move.l #Q_SIZE, %d1
 266      0100 
 267 01c8 5341      		subq #1, %d1      | %d1 = #255
 268               	
 269               	Init_Q_LOOP:
 270 01ca 2248      		movea.l %a0, %a1
 271 01cc D3C1      		adda.l %d1, %a1   | %a1 = QUEUEno „ÅÆÊú´Â∞æ„Ç¢„Éâ„É¨„Çπ
 272 01ce 2148 0100 		move.l %a0, (%a0, top_ofs)
 273 01d2 2148 0108 		move.l %a0, (%a0, out_ofs)
 274 01d6 2148 010C 		move.l %a0, (%a0, in_ofs)
 275 01da 2149 0104 		move.l %a1, (%a0, bottom_ofs)
 276 01de 217C 0000 		move.l #0, (%a0, s_ofs)
 276      0000 0110 
 277               		
 278 01e6 D1FC 0000 		adda.l #Q_STRIDE, %a0
 278      0114 
 279 01ec 51C8 FFDC 		dbra   %d0, Init_Q_LOOP
 280               	
 281 01f0 4CDF 0303 		movem.l	(%sp)+,%d0-%d1/%a0-%a1
 282 01f4 4E75      		rts
 283               		
 284               	***********************************
 285               	** INQ: „Ç≠„É•„Éº„Å∏„ÅÆ„Éá„Éº„ÇøÊõ∏„ÅçËæº„Åø
 286               	** ÂÖ•Âäõ d0.l: „Ç≠„É•„Éº„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
 287               	**      d1.b: Êõ∏„ÅçËæº„ÇÄ„Éá„Éº„Çø
 288               	** Âá∫Âäõ d0.l: ÁµêÊûú(00:Â§±Êïó, 00‰ª•Â§ñ:ÊàêÂäü)
 289               	***********************************
 290               	INQ:
 291 01f6 48E7 60E0 		movem.l	%d1-%d2/%a0-%a2,-(%sp)
 292 01fa 40E7      		move.w	%sr,-(%sp)
 293 01fc 46FC 2700 		move.w	#0x2700,%sr | Ëµ∞Ë°å„É¨„Éô„É´Ôºó
 294 0200 4EBA 000A 		jsr	PUT_BUF
 295 0204 46DF      		move.w	(%sp)+,%sr  | ÊóßËµ∞Ë°å„É¨„Éô„É´„ÅÆÂõûÂæ©
 296 0206 4CDF 0706 		movem.l	(%sp)+,%d1-%d2/%a0-%a2
 297 020a 4E75      		rts
 298               	
 299               	****************************************
 300               	** PUT_BUF
 301               	****************************************
 302               	PUT_BUF:
 303 020c C0FC 0114 		mulu #Q_STRIDE, %d0
 304 0210 41F9 0000 		lea.l QUEUE0, %a0
68K GAS  mon.s 			page 8


 304      0000 
 305 0216 D1C0      		adda.l %d0, %a0   |%a0 = „Ç≠„É•„Éºno „ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ
 306               	
 307 0218 2428 0110 		move.l (%a0,s_ofs), %d2
 308 021c 0C82 0000 		cmpi.l #Q_SIZE, %d2
 308      0100 
 309 0222 6700 0022 		beq PUT_BUF_FALSE
 310               		
 311 0226 2268 010C 		movea.l (%a0, in_ofs), %a1
 312 022a 12C1      		move.b %d1,(%a1)+
 313               	
 314 022c 2468 0104 		move.l (%a0, bottom_ofs), %a2    | %a2 = „Ç≠„É•„ÉºÁµÇÁ´Ø„Ç¢„Éâ„É¨„Çπ
 315 0230 B3CA      		cmpa.l %a2, %a1
 316 0232 6300 0004 		bls PUT_BUF_STEP1           | in „Åå„Ç≠„É•„Éº„ÅÆÁµÇÁ´Ø„Çí„Åì„Åà„Åü„Çâ
 317 0236 2248      		move.l %a0, %a1             | %a1 = „Ç≠„É•„Éºno„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ
 318               		
 319               	PUT_BUF_STEP1:	
 320 0238 2149 010C 		move.l %a1, (%a0, in_ofs)
 321 023c 52A8 0110 		addq.l #1, (%a0, s_ofs)
 322 0240 7001      		moveq.l #1, %d0
 323 0242 6000 0004 		bra PUT_BUF_end
 324               	
 325               	PUT_BUF_FALSE:
 326 0246 7000      		move.l	#0, %d0
 327               	
 328               	PUT_BUF_end:
 329 0248 4E75      		rts
 330               	
 331               	***********************************
 332               	** OUTQ : „Ç≠„É•„Éº„Å∏„ÅÆ„Éá„Éº„ÇøÊõ∏„ÅçËæº„Åø
 333               	** ÂÖ•Âäõ d0.l : „Ç≠„É•„ÉºÁï™Âè∑
 334               	** Âá∫Âäõ d0.l : ÁµêÊûú(00:Â§±Êïó, 00‰ª•Â§ñ:ÊàêÂäü)
 335               	***********************************
 336               	OUTQ:
 337 024a 48E7 20E0 		movem.l	%d2/%a0-%a2,-(%sp)
 338 024e 40E7      		move.w	%sr,-(%sp)
 339 0250 46FC 2700 		move.w	#0x2700,%sr
 340 0254 4EBA 000A 		jsr	GET_BUF
 341 0258 46DF      		move.w	(%sp)+,%sr
 342 025a 4CDF 0704 		movem.l	(%sp)+,%d2/%a0-%a2
 343 025e 4E75      		rts
 344               	
 345               	****************************************
 346               	** GET_BUF
 347               	****************************************
 348               	GET_BUF:
 349 0260 7200      		moveq.l #0, %d1
 350 0262 C0FC 0114 		mulu #Q_STRIDE, %d0
 351 0266 41F9 0000 		lea.l QUEUE0, %a0
 351      0000 
 352 026c D1C0      		adda.l %d0, %a0   /* %a0 = ÂÖàÈ†≠ */
 353               	
 354 026e 2428 0110 		move.l (%a0,s_ofs), %d2
 355 0272 0C82 0000 		cmpi.l #0, %d2
 355      0000 
 356 0278 6700 0026 		beq GET_BUF_FALSE
 357               		
68K GAS  mon.s 			page 9


 358 027c 2268 0108 		movea.l (%a0, out_ofs), %a1
 359 0280 1211      		move.b (%a1), %d1
 360 0282 12FC 0000 		move.b #0, (%a1)+
 361               	
 362 0286 2468 0104 		move.l (%a0, bottom_ofs), %a2    /* %a2 = „Ç≠„É•„ÉºÁµÇÁ´Ø„Ç¢„Éâ„É¨„Çπ */
 363 028a B3CA      		cmpa.l %a2, %a1
 364 028c 6300 0004 		bls GET_BUF_STEP1           /* ÁµÇÁ´Ø„Å´Âà∞ÈÅî„Åó„Åü„Çâ */
 365 0290 2248      		move.l %a0, %a1              /* %a1 = „Ç≠„É•„ÉºÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
 366               		
 367               	GET_BUF_STEP1:	
 368 0292 2149 0108 		move.l %a1, (%a0, out_ofs)
 369 0296 53A8 0110 		subq.l   #1, (%a0, s_ofs)
 370 029a 7001      		moveq.l #1, %d0
 371 029c 6000 0004 		bra GET_BUF_end
 372               	
 373               	GET_BUF_FALSE:
 374 02a0 7000      		move.l	#0,%d0
 375               	
 376               	GET_BUF_end:
 377 02a2 4E75      		rts
 378               	
 379               	******************************
 380               	** „Ç≠„É•„ÉºÁî®„ÅÆ„É°„É¢„É™È†òÂüüÁ¢∫‰øù
 381               	******************************
 382               	.section .data
 383               	.even
 384 0000 0000 0000 	QUEUE0: .ds.b Q_STRIDE
 384      0000 0000 
 384      0000 0000 
 384      0000 0000 
 384      0000 0000 
 385 0114 0000 0000 	QUEUE1: .ds.b Q_STRIDE
 385      0000 0000 
 385      0000 0000 
 385      0000 0000 
 385      0000 0000 
 386 0228 0000 0000 	QUEUE2: .ds.b Q_STRIDE
 386      0000 0000 
 386      0000 0000 
 386      0000 0000 
 386      0000 0000 
 387 033c 0000 0000 	QUEUE3: .ds.b Q_STRIDE
 387      0000 0000 
 387      0000 0000 
 387      0000 0000 
 387      0000 0000 
 388               	
 389               	.section .text
 390               	.even
 391               	***************************
 392               	** %d1.l = ch
 393               	** %d2.b = Âèó‰ø°„Éá„Éº„Çø  data
 394               	** Êàª„ÇäÂÄ§  „Å™„Åó
 395               	***************************
 396               	/* Âèó‰ø°„É¨„Ç∏„Çπ„Çø„ÅÆÂÄ§„ÅØ„Åô„Åß„Å´d2„Å´Ê†ºÁ¥ç„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ„ÅÇ„Å®„ÅØÈÄÅ‰ø°„Ç≠„É•„Éº„Å´ÂÖ•„
 397               	INTERGET:
 398 02a4 0C81 0000 		cmpi.l #0, %d1    /* ch != 0,1 „Å™„ÇâÁµÇ‰∫Ü */
68K GAS  mon.s 			page 10


 398      0000 
 399 02aa 6700 0012 		beq INTERGET_CH0
 400 02ae 0C81 0000 		cmpi.l #1, %d1
 400      0001 
 401 02b4 6600 0010 		bne INTERGET_END
 402 02b8 7002      		moveq.l #2, %d0
 403 02ba 6000 0004 		bra INTERGET_DO 
 404               	INTERGET_CH0:	
 405 02be 7000      		moveq.l #0, %d0   /* „Ç≠„É•„ÉºÁï™Âè∑„Çí 0 „Å´Ë®≠ÂÆö */          
 406               	INTERGET_DO:
 407 02c0 1202      	    move.b %d2, %d1   /* %d1 = data */
 408 02c2 4EBA FF32 		jsr INQ           /* INQ(2, data) */
 409               	INTERGET_END:
 410 02c6 4E75      		rts
 411               		
 412               	**********************************************
 413               	** %d1.l = ch
 414               	** %d2.l = Êõ∏„ÅçËæº„ÅøÂÖà„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ p
 415               	** %d3.l = Âèñ„ÇäÂá∫„Åô„Éá„Éº„ÇøÊï∞  size
 416               	** Êàª„ÇäÂÄ§  %d0.l = ÂÆüÈöõ„Å´Âèñ„ÇäÂá∫„Åó„Åü„Éá„Éº„ÇøÊï∞  sz 
 417               	**********************************************
 418               	/* Âèó‰ø°„Ç≠„É•„Éº„Å´„ÅÇ„ÇãsizeÂÄã„ÅÆ„Éá„Éº„Çø„Çí„ÄÅpÁï™Âú∞„Å´Êõ∏„ÅçËæº„ÅøÔºàÊ≤≥ÈáéÔºâ */	
 419               	GETSTRING:
 420 02c8 48E7 0880 		movem.l %d4/%a0, -(%sp)
 421 02cc 0C81 0000 		cmp.l #0, %d1            /* ch != 0,1 „Å™„ÇâÁµÇ‰∫Ü */
 421      0000 
 422 02d2 6700 0010 		beq GETSTRING_CH0
 423 02d6 0C81 0000 		cmp.l #1, %d1       
 423      0001 
 424 02dc 6700 000C 		beq GETSTRING_CH1       
 425 02e0 6000 002A 		bra GETSTRING_END
 426               	GETSTRING_CH0:
 427 02e4 7000      		moveq.l #0, %d0          /* %d0 = 0, „Ç≠„É•„ÉºÁï™Âè∑„Çí0„Å´ */                  
 428 02e6 6000 0004 		bra GETSTRING_COMMON	
 429               	GETSTRING_CH1:
 430 02ea 7002      		moveq.l #2, %d0         /* %d0 = 2, „Ç≠„É•„ÉºÁï™Âè∑„Çí2„Å´ */
 431               	GETSTRING_COMMON:
 432 02ec 7800      		moveq.l #0, %d4
 433 02ee 2042      		movea.l %d2, %a0
 434               	GETSTRING_LOOP:
 435 02f0 B684      		cmp.l %d4, %d3           /* %d4 = size „Å™„Çâ STEP2 „Å∏ */               
 436 02f2 6700 0018 		beq GETSTRING_END
 437 02f6 4EBA FF52 		jsr OUTQ                 /* OUTQ(0,data) */      
 438 02fa 0C80 0000 		cmpi.l #0, %d0           /* Âæ©Â∏∞ÂÄ§ %d0 „Åå 0 „Å™„Çâ STEP2 „Å∏ */           
 438      0000 
 439 0300 6700 000A 		beq GETSTRING_END      
 440 0304 10C1      		move.b %d1, (%a0)+       /* %a0 Áï™Âú∞„Å∏ data „Çí„Ç≥„Éî„Éº, %a0++ */                             
 441 0306 5284      		addq.l #1, %d4           /* %d4++ */      
 442 0308 6000 FFE6 		bra GETSTRING_LOOP  
 443               	GETSTRING_END:
 444 030c 2004      		move.l %d4, %d0          /* %d0 = %d4 */  
 445 030e 4CDF 0110 		movem.l (%sp)+, %d4/%a0
 446 0312 4E75      		rts
 447               	/*; ---- end include interget.s ----*/
 448               	
 449               	/* ---- begin include timer.s ---- */
 450               	.section .bss
68K GAS  mon.s 			page 11


 451 8100 0000 0000 	task_p:	.ds.b 4 /*„Çø„Ç§„ÉûÂâ≤„ÇäËæº„Åø„ÅßÂÆüË°å„Åô„Çã„Éó„É≠„Ç∞„É©„É†„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ„ÇíÊ†ºÁ¥ç
 452               	
 453               	/*„Çø„Ç§„Éû„É´„Éº„ÉÅ„É≥*/
 454               	
 455               	.section .text
 456               	
 457               	/*
 458               	„Çø„Ç§„Éû1„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
 459               	TCTL1 
 460               	    bit 4  : Interrupt Request EnableÔºàÊØîËºÉÂâ≤„ÇäËæº„ÅøÔºâ 0=disable, 1=enable
 461               	    bit 3-1: Clock Source 001 = ÂÖ•Âäõ„ÅØ SYSCLKÔºé010 = ÂÖ•Âäõ„ÅØ SYSCLK/16Ôºé011 = ÂÖ•Âäõ„ÅØ TINÔ
 462               	    bit 0  : Timer Enable. 0=disable. 1=enable
 463               	ÔºàÊ•†Áî∞„ÉªÈ¥ª‰∏äÔºâ
 464               	*/
 465               	
 466               	
 467               	/* RESET_TIMER
 468               	 *   „Çø„Ç§„ÉûÂâ≤„ÇäËæº„Åø„Çí‰∏çÂèØ„Å´„ÄÇ„Çø„Ç§„Éû„ÇíÂÅúÊ≠¢„ÄÇÔºàÊ•†Áî∞„ÉªÈ¥ª‰∏äÔºâ
 469               	 */
 470               	RESET_TIMER:
 471 0314 33FC 0004 		move.w #0x0004, TCTL1 | TCTL1=0b0_010_0
 471      00FF F600 
 472 031c 4E75      		rts
 473               	
 474               	/* SET_TIMER:
 475               	 *   „Çø„Ç§„ÉûÂâ≤„ÇäËæº„ÅøÊôÇ„Å´Ëµ∑Âãï„Åô„Çã„Çµ„Éñ„É´„Éº„ÉÅ„É≥„ÇíË®≠ÂÆö
 476               	 *   t * 0.1 msec ÁßíÊØé„Å´Ââ≤„ÇäËæº„Åø„ÅåÁô∫Áîü„Åô„Çã„Çà„ÅÜ„Å´Ë®≠ÂÆö
 477               	 * 
 478               	 * %D1.W: „Çø„Ç§„ÉûÂâ≤„ÇäËæº„ÅøÁô∫ÁîüÂë®Êúü t
 479               	 * %D2.L: Ââ≤„ÇäËæº„ÅøÊôÇ„Å´Ëµ∑Âãï„Åô„Çã„É´„Éº„ÉÅ„É≥„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ p
 480               	 * ÔºàÊ•†Áî∞„ÉªÈ¥ª‰∏äÔºâ
 481               	 */
 482               	SET_TIMER:
 483 031e 23C2 0000 		move.l %D2, task_p  /* Ââ≤„ÇäËæº„ÅøÊôÇ„Å´Âëº„Å≥Âá∫„Åô„Çµ„Éñ„É´„Éº„ÉÅ„É≥„ÅÆ„Ç¢„Éâ„É¨„Çπ„Çítask_p„Å´
 483      0000 
 484 0324 33FC 00CE 		move.w #206, TPRER1 /*„Ç´„Ç¶„É≥„ÇøÂë®Ê≥¢Êï∞„Çí10000„Å´„Åô„Çã-> Âë®Êúü0.1msec*/
 484      00FF F602 
 485 032c 33C1 00FF 		move.w %D1, TCMP1   /* TCMP1 = t ÔºàÊ•†Áî∞„ÉªÈ¥ª‰∏äÔºâ */
 485      F604 
 486 0332 33FC 0015 		move.w #0x0015, TCTL1 /*ÊØîËºÉÂâ≤„ÇäËæº„ÅøË®±ÂèØ, 1/16Âë®Êúü, „Çø„Ç§„ÉûË®±ÂèØ*/
 486      00FF F600 
 487               	                          /* TCTL1 = 0b1_010_1 ÔºàÊ•†Áî∞„ÉªÈ¥ª‰∏äÔºâ*/
 488 033a 4E75      		rts
 489               	
 490               	/* CALL_RP:
 491               	 *   „Çø„Ç§„ÉûÂâ≤„ÇäËæº„ÅøÊôÇ„Å´Âá¶ÁêÜ„Åô„Åπ„Åç„É´„Éº„ÉÅ„É≥„ÇíÂëº„Å≥Âá∫„Åô
 492               	 * ÔºàÊ•†Áî∞„ÉªÈ¥ª‰∏äÔºâ
 493               	 */
 494               	CALL_RP:
 495 033c 2079 0000 		movea.l task_p, %A0 /*task_p„Çí‰Ωø„Å£„Å¶„Ç∏„É£„É≥„Éó„Åß„Åç„Å™„ÅÑ„Åü„ÇÅA0„É¨„Ç∏„Çπ„Çø„Å´„Ç¢„Éâ„É¨„Ç
 495      0000 
 496 0342 4E90      		jsr  (%A0)  /* Ââ≤„ÇäËæº„ÅøÊôÇ„Å´Ëµ∑Âãï„Åô„Çã„É´„Éº„ÉÅ„É≥„Å´ÈÅ∑ÁßªÔºàÊ•†Áî∞„ÉªÈ¥ª‰∏äÔºâ */
 497 0344 4E75      		rts
 498               	/*; ---- end include timer.s ----*/
 499               	
 500               	
 501               	uart1_interrupt:
68K GAS  mon.s 			page 12


 502               	/*ÈÄÅ‰ø°Ââ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„Å®Âèó‰ø°Ââ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÅåÂêå„Åò„Åß„ÅÇ„Çã„Åü„ÇÅÂèó‰ø°„É¨„Ç∏„Çπ„
 503 0346 48E7 FFFE 	    movem.l %D0-%D7/%A0-%A6, -(%SP) | ‰ΩøÁî®„Åô„Çã„É¨„Ç∏„Çπ„Çø„Çí„Çπ„Çø„ÉÉ„ÇØ„Å´‰øùÂ≠ò
 504 034a 3039 00FF 	    move.w UTX1, %D0                | UTX1„ÇíD0„É¨„Ç∏„Çπ„Çø„Å´„Ç≥„Éî„Éº„Åó‰øùÂ≠ò„Åó„Å¶„Åä„Åè
 504      F906 
 505 0350 3200      	    move.w %D0, %D1                 | Ë®àÁÆóÁî®„Å´D1„É¨„Ç∏„Çπ„Çø„Å´„Ç≥„Éî„Éº
 506 0352 E049      	    lsr.w #8, %D1
 507 0354 EE49      	    lsr.w #7, %D1                   | 15ÂõûÂè≥„Ç∑„Éï„ÉàÔºà‰∏ä‰Ωç„Éì„ÉÉ„Éà„ÅØ0Âüã„ÇÅÔºâ
 508 0356 0C41 0001 	    cmpi.w #1, %D1                  | 0=FIFO„ÅåÁ©∫„Åß„ÅØ„Å™„ÅÑ, 1=Á©∫„Åß„ÅÇ„ÇãÔºàÂâ≤„ÇäËæº„ÅøÁô∫Áîü
 509 035a 6600 0008 	    bne UART1_INTR_SKIP_PUT         | ÈÄÅ‰ø°Ââ≤„ÇäËæº„Åø„Åß„Å™„ÅÑ„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó Âèó‰ø°Ââ≤„ÇäËæº
 510 035e 7200      	    move.l #0, %D1                  | ch=%D1.L=0
 511 0360 4EBA FD86 	    jsr INTERPUT
 512               	UART1_INTR_SKIP_PUT:
 513 0364 3639 00FF 	    move.w URX1, %D3                | Âèó‰ø°„É¨„Ç∏„Çπ„Çø URX1 „Çí %D3.W „Å´„Ç≥„Éî„Éº
 513      F904 
 514 036a 1403      	    move.b %D3, %D2                 | %D3.W „ÅÆ‰∏ã‰Ωç 8bit(„Éá„Éº„ÇøÈÉ®ÂàÜ) „Çí %D2.B „Å´„Ç≥„Éî„Éº
 515 036c E04B      	    lsr.w #8, %D3
 516 036e EA4B      	    lsr.w #5, %D3                   | 13ÂõûÂè≥„Ç∑„Éï„ÉàÔºà‰∏ä‰Ωç„Éì„ÉÉ„Éà„ÅØ0Âüã„ÇÅÔºâ
 517 0370 0243 0001 	    and.w #0x1, %D3                 | 0bitÁõÆ‰ª•Â§ñ„Çí0„Å´
 518 0374 0C43 0001 	    cmpi.w #1, %D3                  | 0 = Âèó‰ø° FIFO „Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÔºé1 = „Éá„Éº„Çø„Åå„ÅÇ„Ç
 519 0378 6600 0008 	    bne UART1_INTR_SKIP_GET
 520 037c 4281      	    clr.l %D1                       | ch = %D1.L = 0, (data = %D2.B„ÅØ‰ª£ÂÖ•Ê∏à)
 521 037e 4EBA FF24 	    jsr INTERGET
 522               	UART1_INTR_SKIP_GET:
 523 0382 4CDF 7FFF 	    movem.l (%SP)+, %D0-%D7/%A0-%A6 | „É¨„Ç∏„Çπ„Çø„ÇíÂæ©Â∏∞
 524 0386 4E73      	    rte
 525               	    
 526               	    
 527               	    
 528               	uart2_interrupt:
 529               	/*ÈÄÅ‰ø°Ââ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„Å®Âèó‰ø°Ââ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„ÅåÂêå„Åò„Åß„ÅÇ„Çã„Åü„ÇÅÂèó‰ø°„É¨„Ç∏„Çπ„
 530 0388 48E7 FFFE 	    movem.l %D0-%D7/%A0-%A6, -(%SP) | ‰ΩøÁî®„Åô„Çã„É¨„Ç∏„Çπ„Çø„Çí„Çπ„Çø„ÉÉ„ÇØ„Å´‰øùÂ≠ò
 531 038c 3039 00FF 	    move.w UTX2, %D0                | UTX2„ÇíD0„É¨„Ç∏„Çπ„Çø„Å´„Ç≥„Éî„Éº„Åó‰øùÂ≠ò„Åó„Å¶„Åä„Åè
 531      F916 
 532 0392 3200      	    move.w %D0, %D1                 | Ë®àÁÆóÁî®„Å´D1„É¨„Ç∏„Çπ„Çø„Å´„Ç≥„Éî„Éº
 533 0394 E049      	    lsr.w #8, %D1
 534 0396 EE49      	    lsr.w #7, %D1                   | 15ÂõûÂè≥„Ç∑„Éï„ÉàÔºà‰∏ä‰Ωç„Éì„ÉÉ„Éà„ÅØ0Âüã„ÇÅÔºâ
 535 0398 0C41 0001 	    cmpi.w #1, %D1                  | 0=FIFO„ÅåÁ©∫„Åß„ÅØ„Å™„ÅÑ, 1=Á©∫„Åß„ÅÇ„ÇãÔºàÂâ≤„ÇäËæº„ÅøÁô∫Áîü
 536 039c 6600 0008 	    bne UART2_INTR_SKIP_PUT         | ÈÄÅ‰ø°Ââ≤„ÇäËæº„Åø„Åß„Å™„ÅÑ„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó Âèó‰ø°Ââ≤„ÇäËæº
 537 03a0 7201      	    move.l #1, %D1                  | ch=%D1.L=1
 538 03a2 4EBA FD44 	    jsr INTERPUT
 539               	UART2_INTR_SKIP_PUT:
 540 03a6 3639 00FF 	    move.w URX2, %D3                | Âèó‰ø°„É¨„Ç∏„Çπ„Çø URX2 „Çí %D3.W „Å´„Ç≥„Éî„Éº
 540      F914 
 541 03ac 1403      	    move.b %D3, %D2                 | %D3.W „ÅÆ‰∏ã‰Ωç 8bit(„Éá„Éº„ÇøÈÉ®ÂàÜ) „Çí %D2.B „Å´„Ç≥„Éî„Éº
 542 03ae E04B      	    lsr.w #8, %D3
 543 03b0 EA4B      	    lsr.w #5, %D3                   | 13ÂõûÂè≥„Ç∑„Éï„ÉàÔºà‰∏ä‰Ωç„Éì„ÉÉ„Éà„ÅØ0Âüã„ÇÅÔºâ
 544 03b2 0243 0001 	    and.w #0x1, %D3                 | 0bitÁõÆ‰ª•Â§ñ„Çí0„Å´
 545 03b6 0C43 0001 	    cmpi.w #1, %D3                  | 0 = Âèó‰ø° FIFO „Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÔºé1 = „Éá„Éº„Çø„Åå„ÅÇ„Ç
 546 03ba 6600 0008 	    bne UART2_INTR_SKIP_GET
 547 03be 7201      	    move.l #1, %D1                  | ch = %D1.L = 1, (data = %D2.B„ÅØ‰ª£ÂÖ•Ê∏à)
 548 03c0 4EBA FEE2 	    jsr INTERGET
 549               	UART2_INTR_SKIP_GET:
 550 03c4 4CDF 7FFF 	    movem.l (%SP)+, %D0-%D7/%A0-%A6 | „É¨„Ç∏„Çπ„Çø„ÇíÂæ©Â∏∞
 551 03c8 4E73      	    rte
 552               	    
 553               	    
 554               	    
68K GAS  mon.s 			page 13


 555               	tmr1_interrupt:
 556 03ca 48E7 FFFE 	    movem.l %D0-%D7/%A0-%A6,-(%SP)  | ‰ΩøÁî®„Åô„Çã„É¨„Ç∏„Çπ„Çø„Çí„Çπ„Çø„ÉÉ„ÇØ„Å´‰øùÂ≠ò
 557 03ce 0C80 0000 	    cmpi.l #5, %D0
 557      0005 
 558 03d4 6700 0014 	    beq TMR1_TRUE
 559 03d8 3039 00FF 	    move.w TSTAT1, %D0              | %D0=TSTAT1
 559      F60A 
 560 03de 0240 0001 	    and.w #0x1, %D0                 | 0bitÁõÆ‰ª•Â§ñ„Çí0„Å´
 561 03e2 0C40 0000 	    cmp.w #0, %D0
 562 03e6 6700 000C 	    beq TMR1_END                    | TSTAT1 „ÅÆÁ¨¨ 0 „Éì„ÉÉ„Éà„Åå 1 „Å®„Å™„Å£„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã
 563               	    /*TASTAT1„ÅÆÁ¨¨0„Éì„ÉÉ„Éà„Åå0„ÅÆ„Å®„Åç„ÅØ„Ç≥„É≥„Éö„Ç¢„Ç§„Éô„É≥„Éà„ÅåËµ∑„Åç„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„Çø
 564               	TMR1_TRUE:    
 565 03ea 4279 00FF 	    clr.w TSTAT1                    | TSTAT1 „Çí 0 „ÇØ„É™„Ç¢
 565      F60A 
 566 03f0 4EBA FF4A 	    jsr CALL_RP /*„Çø„Ç§„ÉûÂâ≤„ÇäËæº„Åø„ÅåÁô∫Áîü„Åó„ÅüÊôÇ„Å´Âá¶ÁêÜ„Åô„Åπ„Åç„É´„Éº„ÉÅ„É≥„Å´ÁßªÂãï„Åô
 567               	TMR1_END:
 568 03f4 4CDF 7FFF 	    movem.l (%SP)+, %D0-%D7/%A0-%A6 | „É¨„Ç∏„Çπ„Çø„ÇíÂæ©Â∏∞
 569 03f8 4E73      	    rte
 570               	
 571               	.end
68K GAS  mon.s 			page 14


DEFINED SYMBOLS
              defs.s:2      *ABS*:0000000000fff000 REGBASE
              defs.s:3      *ABS*:0000000000d00000 IOBASE
              defs.s:6      *ABS*:0000000000fff300 IVR
              defs.s:7      *ABS*:0000000000fff304 IMR
              defs.s:8      *ABS*:0000000000fff30c ISR
              defs.s:9      *ABS*:0000000000fff310 IPR
              defs.s:12     *ABS*:0000000000fff600 TCTL1
              defs.s:13     *ABS*:0000000000fff602 TPRER1
              defs.s:14     *ABS*:0000000000fff604 TCMP1
              defs.s:15     *ABS*:0000000000fff608 TCN1
              defs.s:16     *ABS*:0000000000fff60a TSTAT1
              defs.s:19     *ABS*:0000000000fff900 USTCNT1
              defs.s:20     *ABS*:0000000000fff902 UBAUD1
              defs.s:21     *ABS*:0000000000fff904 URX1
              defs.s:22     *ABS*:0000000000fff906 UTX1
              defs.s:25     *ABS*:0000000000fff910 USTCNT2
              defs.s:26     *ABS*:0000000000fff912 UBAUD2
              defs.s:27     *ABS*:0000000000fff914 URX2
              defs.s:28     *ABS*:0000000000fff916 UTX2
              defs.s:32     *ABS*:0000000000d0002f LED7
              defs.s:33     *ABS*:0000000000d0002d LED6
              defs.s:34     *ABS*:0000000000d0002b LED5
              defs.s:35     *ABS*:0000000000d00029 LED4
              defs.s:36     *ABS*:0000000000d0003f LED3
              defs.s:37     *ABS*:0000000000d0003d LED2
              defs.s:38     *ABS*:0000000000d0003b LED1
              defs.s:39     *ABS*:0000000000d00039 LED0
              defs.s:42     *ABS*:0000000000000001 SYSCALL_NUM_GETSTRING
              defs.s:43     *ABS*:0000000000000002 SYSCALL_NUM_PUTSTRING
              defs.s:44     *ABS*:0000000000000003 SYSCALL_NUM_RESET_TIMER
              defs.s:45     *ABS*:0000000000000004 SYSCALL_NUM_SET_TIMER
              defs.s:46     *ABS*:0000000000000005 SYSCALL_NUM_SKIPMT
               mon.s:6      .bss:0000000000000000 SYS_STK
               mon.s:8      .bss:0000000000004000 SYS_STK_TOP
               mon.s:15     .text:0000000000000000 monitor_begin
               mon.s:16     .text:0000000000000000 boot
               mon.s:97     .text:000000000000008c syscall_handler
               mon.s:501    .text:0000000000000346 uart1_interrupt
               mon.s:528    .text:0000000000000388 uart2_interrupt
               mon.s:555    .text:00000000000003ca tmr1_interrupt
               mon.s:261    .text:00000000000001b4 Init_Q
               mon.s:62     .bss:0000000000004000 BUF
               mon.s:65     .bss:0000000000004100 USR_STK
               mon.s:68     .bss:0000000000008100 USR_STK_TOP
               mon.s:121    .text:00000000000000c8 CALL_GETSTRING
               mon.s:125    .text:00000000000000d0 CALL_PUTSTRING
               mon.s:129    .text:00000000000000d8 CALL_RESET_TIMER
               mon.s:132    .text:00000000000000e0 CALL_SET_TIMER
               mon.s:114    .text:00000000000000c2 END_SYSCALL_HNDR
               mon.s:419    .text:00000000000002c8 GETSTRING
               mon.s:194    .text:000000000000014c PUTSTRING
               mon.s:470    .text:0000000000000314 RESET_TIMER
               mon.s:482    .text:000000000000031e SET_TIMER
               mon.s:144    .text:00000000000000e8 INTERPUT
               mon.s:155    .text:0000000000000108 INTERPUT_CH0
               mon.s:161    .text:000000000000011a INTERPUT_CH1
68K GAS  mon.s 			page 15


               mon.s:182    .text:0000000000000146 End_INTERPUT
               mon.s:165    .text:0000000000000128 INTERPUT_COMMON
               mon.s:336    .text:000000000000024a OUTQ
               mon.s:177    .text:000000000000013e INTERPUT_MASK
               mon.s:202    .text:0000000000000168 PUTSTRING_CH0
               mon.s:206    .text:0000000000000174 PUTSTRING_CH1
               mon.s:242    .text:00000000000001ae End_PUTSTRING
               mon.s:209    .text:000000000000017c PUTSTRING_COMMON
               mon.s:239    .text:00000000000001ac PUTSTRING_10
               mon.s:216    .text:0000000000000188 LOOP_PUTSTRING
               mon.s:234    .text:00000000000001a4 PUTSTRING_9
               mon.s:290    .text:00000000000001f6 INQ
               mon.s:250    *ABS*:0000000000000100 Q_SIZE
               mon.s:251    *ABS*:0000000000000004 Q_COUNT
               mon.s:252    *ABS*:0000000000000100 top_ofs
               mon.s:253    *ABS*:0000000000000104 bottom_ofs
               mon.s:254    *ABS*:0000000000000108 out_ofs
               mon.s:255    *ABS*:000000000000010c in_ofs
               mon.s:256    *ABS*:0000000000000110 s_ofs
               mon.s:257    *ABS*:0000000000000114 Q_STRIDE
               mon.s:384    .data:0000000000000000 QUEUE0
               mon.s:269    .text:00000000000001ca Init_Q_LOOP
               mon.s:302    .text:000000000000020c PUT_BUF
               mon.s:325    .text:0000000000000246 PUT_BUF_FALSE
               mon.s:319    .text:0000000000000238 PUT_BUF_STEP1
               mon.s:328    .text:0000000000000248 PUT_BUF_end
               mon.s:348    .text:0000000000000260 GET_BUF
               mon.s:373    .text:00000000000002a0 GET_BUF_FALSE
               mon.s:367    .text:0000000000000292 GET_BUF_STEP1
               mon.s:376    .text:00000000000002a2 GET_BUF_end
               mon.s:385    .data:0000000000000114 QUEUE1
               mon.s:386    .data:0000000000000228 QUEUE2
               mon.s:387    .data:000000000000033c QUEUE3
               mon.s:397    .text:00000000000002a4 INTERGET
               mon.s:404    .text:00000000000002be INTERGET_CH0
               mon.s:409    .text:00000000000002c6 INTERGET_END
               mon.s:406    .text:00000000000002c0 INTERGET_DO
               mon.s:426    .text:00000000000002e4 GETSTRING_CH0
               mon.s:429    .text:00000000000002ea GETSTRING_CH1
               mon.s:443    .text:000000000000030c GETSTRING_END
               mon.s:431    .text:00000000000002ec GETSTRING_COMMON
               mon.s:434    .text:00000000000002f0 GETSTRING_LOOP
               mon.s:451    .bss:0000000000008100 task_p
               mon.s:494    .text:000000000000033c CALL_RP
               mon.s:512    .text:0000000000000364 UART1_INTR_SKIP_PUT
               mon.s:522    .text:0000000000000382 UART1_INTR_SKIP_GET
               mon.s:539    .text:00000000000003a6 UART2_INTR_SKIP_PUT
               mon.s:549    .text:00000000000003c4 UART2_INTR_SKIP_GET
               mon.s:564    .text:00000000000003ea TMR1_TRUE
               mon.s:567    .text:00000000000003f4 TMR1_END

UNDEFINED SYMBOLS
start

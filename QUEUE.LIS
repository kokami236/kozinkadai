                         4 .list
                         5 .section .text
                         6 
                         7 
                         8 *****************キューの初期化処理*******************************************************
                         9 Init_Q:
000400 48E7 F8F0        10 	movem.l %d0-%d4/%a0-%a3,-(%sp)
000404 7000             11 	moveq 	#0, %d0			/* d0: キュー番号かつカウンタ */
000406 43F9 0000        12 	lea.l	Q_INFO, %a1		/* a1: Q_INFOの開始地点 */
       0000             12 
00040c 45F9 0000        13 	lea.l	Q0_START, %a2 		/* a2: Q0の先頭番地 */
       0000             13 
000412 343C 0100        14 	move.w	#B_SIZE, %d2		/* d2: 256 */
000416 363C 0014        15 	move.w	#Q_INFO_SIZE, %d3	/* d3: 20 (キュー１個分の情報量) */
                        16 
                        17 LOOP_Init:				/* d4: 計算用 */
00041a 2800             18 	move.l	%d0,	%d4
00041c C8C3             19 	mulu	%d3,	%d4		/* d4 = d0 * Q_INFO_SIZE */
00041e 2044             20 	move.l	%d4,	%a0
000420 D1C9             21 	add.l	%a1,	%a0		/* a0 = Q_INFO + d0 * Q_INFO_SIZE(各キュー情報の先頭) */
                        22 	
000422 2800             23 	move.l	%d0,	%d4			
000424 C8C2             24 	mulu	%d2,	%d4		/* d4 = d0 * B_SIZE */
000426 2644             25 	move.l	%d4,	%a3
000428 D7CA             26 	add.l	%a2,	%a3		/* a3 = Q0_START + d0 * B_SIZE(各キューの先頭) */
                        27 
00042a 214B 0000        28 	move.l	%a3,	TOP_OFS(%a0)	
00042e 214B 0004        29 	move.l	%a3,	OUT_OFS(%a0)
000432 214B 0008        30 	move.l	%a3,	IN_OFS(%a0)
                        31 	
000436 D7FC 0000        32 	adda.l	#B_SIZE_MINUS,	%a3
       00FF             32 
00043c 214B 000C        33 	move.l	%a3,	BOTTOM_OFS(%a0)
000440 217C 0000        34 	move.l	#0,	S_OFS(%a0)
       0000 0010        34 
                        35 
000448 5240             36 	addq	#1,	%d0
00044a 0C40 0002        37 	cmp	#2,	%d0
00044e 6600 FFCA        38 	bne	LOOP_Init		/* キュー2つ分繰返し */
                        39 	
                        40 end_Init:	
000452 4CDF 0F1F        41 	movem.l (%sp)+, %d0-%d4/%a0-%a3
000456 4E75             42 	rts
                        43 ***************************************************************************************************
                        44 
                        45 
                        46 ******INTERPUT*************************************************************************************
                        47 	** 入力：d1.l（チャンネル
                        48 
                        49 	
                        50 ***************************************************************************************************
                        51 
                        52 	
                        53 **********INQ**********************************************************************
                        54 *d0 :キュー番号
                        55 *d1 :8bitデータ
                        56 *出力：d0(失敗 0/ 成功 1 )
                        57 INQ:
                        58 	/* (1) */
000458 40E7             59 	move.w %sr, -(%sp)
00045a 48E7 3FFE        60 	movem.l %d2-%d7/%a0-%a6,-(%sp) 
                        61 
                        62 	/* (2) */
00045e 46FC 2700        63 	move.w #0x2700,%sr
                        64 
                        65 	******************************************************************************************
000462 43F9 0000        66 	lea.l	Q_INFO, %a1		/* a1: Q_INFOの開始地点 */
       0000             66 
000468 45F9 0000        67 	lea.l	Q0_START, %a2 		/* a2: Q0の先頭番地 */
       0000             67 
00046e 343C 0100        68 	move.w	#B_SIZE, %d2		/* d2: 256 */
000472 363C 0014        69 	move.w	#Q_INFO_SIZE, %d3	/* d3: 20 (キュー１個分の情報量) */
                        70 	
000476 2800             71 	move.l	%d0,	%d4
000478 C8C3             72 	mulu	%d3,	%d4		/* d4 = d0 * Q_INFO_SIZE */
00047a 2044             73 	move.l	%d4,	%a0
00047c D1C9             74 	add.l	%a1,	%a0		/* a0 = Q_INFO + d0 * Q_INFO_SIZE(各キュー情報の先頭) */
                        75 	
00047e 2800             76 	move.l	%d0,	%d4			
000480 C8C2             77 	mulu	%d2,	%d4		/* d4 = d0 * B_SIZE */
000482 2644             78 	move.l	%d4,	%a3
000484 D7CA             79 	add.l	%a2,	%a3		/* a3 = Q0_START + d0 * B_SIZE(各キューの先頭) */
                        80 	******************************************************************************************
                        81 
                        82 	/* (3) */
000486 2828 0010        83 	move.l	S_OFS(%a0), %d4
00048a 0C84 0000        84 	cmpi.l	#256, %d4
       0100             84 
000490 6700 0006        85 	beq	INQ_Failure
000494 6000 0008        86 	bra	INQ_Step1
                        87 INQ_Failure:
000498 7000             88 	moveq	#0, %d0
00049a 6000 0038        89 	bra	END_INQ
                        90 INQ_Step1:
                        91 	/* (4) */
00049e 2868 0008        92 	move.l	IN_OFS(%a0), %a4
0004a2 1881             93 	move.b	%d1, (%a4)
                        94 
                        95 	/* (5) */
0004a4 2868 0008        96 	movea.l	IN_OFS(%a0), %a4
0004a8 2A68 000C        97 	movea.l	BOTTOM_OFS(%a0), %a5
0004ac BBCC             98 	cmpa.l	%a4, %a5
0004ae 6700 0010        99 	beq	BACK_IN
0004b2 2868 0008       100 	movea.l	IN_OFS(%a0), %a4
0004b6 524C            101 	addq	#1, %a4
0004b8 214C 0008       102 	move.l	%a4, IN_OFS(%a0)
0004bc 6000 000A       103 	bra	INQ_Step2
                       104 BACK_IN:
0004c0 2868 0000       105 	movea.l	TOP_OFS(%a0), %a4
0004c4 214C 0008       106 	move.l	%a4, IN_OFS(%a0)
                       107 INQ_Step2:
                       108 	/* (6) */
0004c8 2828 0010       109 	move.l	S_OFS(%a0), %d4
0004cc 5284            110 	addq.l	#1, %d4
0004ce 2144 0010       111 	move.l	%d4, S_OFS(%a0)
0004d2 7001            112 	moveq	#1, %d0
                       113 	
                       114 END_INQ:	
                       115 	/* (7) */
0004d4 4CDF 7FFC       116 	movem.l (%sp)+, %d2-%d7/%a0-%a6
0004d8 46DF            117 	move.w (%sp)+, %sr
0004da 4E75            118 	rts
                       119 
                       120 ***********************************************************************************
                       121 
                       122 
                       123 **********OUTQ**********************************************************************
                       124 *d0 :キュー番号
                       125 *出力１：d0(失敗 0/ 成功 1 )
                       126 *出力２：d1（取り出した8bitデータ）
                       127 
                       128 OUTQ:
                       129 	/* (1) */
0004dc 40E7            130 	move.w %sr, -(%sp)
0004de 48E7 3FFE       131 	movem.l %d2-%d7/%a0-%a6,-(%sp) 
                       132 
                       133 	/* (2) */
0004e2 46FC 2700       134 	move.w #0x2700,%sr
                       135 
                       136 	******************************************************************************************
0004e6 43F9 0000       137 	lea.l	Q_INFO, %a1		/* a1: Q_INFOの開始地点 */
       0000            137 
0004ec 45F9 0000       138 	lea.l	Q0_START, %a2 		/* a2: Q0の先頭番地 */
       0000            138 
0004f2 343C 0100       139 	move.w	#B_SIZE, %d2		/* d2: 256 */
0004f6 363C 0014       140 	move.w	#Q_INFO_SIZE, %d3	/* d3: 20 (キュー１個分の情報量) */
                       141 	
0004fa 2800            142 	move.l	%d0,	%d4
0004fc C8C3            143 	mulu	%d3,	%d4		/* d4 = d0 * Q_INFO_SIZE */
0004fe 2044            144 	move.l	%d4,	%a0
000500 D1C9            145 	add.l	%a1,	%a0		/* a0 = Q_INFO + d0 * Q_INFO_SIZE(各キュー情報の先頭) */
                       146 	
000502 2800            147 	move.l	%d0,	%d4			
000504 C8C2            148 	mulu	%d2,	%d4		/* d4 = d0 * B_SIZE */
000506 2644            149 	move.l	%d4,	%a3
000508 D7CA            150 	add.l	%a2,	%a3		/* a3 = Q0_START + d0 * B_SIZE(各キューの先頭) */
                       151 	******************************************************************************************
                       152 
                       153 	/* (3) */
00050a 2828 0010       154 	move.l	S_OFS(%a0), %d4
00050e 0C84 0000       155 	cmpi.l	#0, %d4
       0000            155 
000514 6700 0006       156 	beq	OUTQ_Failure
000518 6000 0008       157 	bra	OUTQ_Step1
                       158 OUTQ_Failure:
00051c 7000            159 	moveq	#0, %d0
00051e 6000 0038       160 	bra	END_OUTQ
                       161 OUTQ_Step1:
                       162 	/* (4) */
000522 2868 0004       163 	move.l	OUT_OFS(%a0), %a4
000526 1214            164 	move.b	(%a4), %d1
                       165 
                       166 	/* (5) */
000528 2868 0004       167 	movea.l	OUT_OFS(%a0), %a4
00052c 2A68 000C       168 	movea.l	BOTTOM_OFS(%a0), %a5
000530 BBCC            169 	cmpa.l	%a4, %a5
000532 6700 0010       170 	beq	BACK_OUT
000536 2868 0004       171 	movea.l	OUT_OFS(%a0), %a4
00053a 524C            172 	addq	#1, %a4
00053c 214C 0004       173 	move.l	%a4, OUT_OFS(%a0)
000540 6000 000A       174 	bra	OUTQ_Step2
                       175 BACK_OUT:
000544 2868 0000       176 	movea.l	TOP_OFS(%a0), %a4
000548 214C 0004       177 	move.l	%a4, OUT_OFS(%a0)
                       178 OUTQ_Step2:
                       179 	/* (6) */
00054c 2828 0010       180 	move.l	S_OFS(%a0), %d4
000550 5384            181 	subq.l	#1, %d4
000552 2144 0010       182 	move.l	%d4, S_OFS(%a0)
000556 7001            183 	moveq	#1, %d0
                       184 	
                       185 END_OUTQ:	
                       186 	/* (7) */
000558 4CDF 7FFC       187 	movem.l (%sp)+, %d2-%d7/%a0-%a6
00055c 46DF            188 	move.w (%sp)+, %sr
00055e 4E75            189 	rts
                       190 
                       191 ***********************************************************************************
                       192 
                       193 
                       194 	
                       195 .section .data
                       196 ******************************
                       197 ** キュー用のメモリ領域確保と定数定義
                       198 ******************************
                       199 	.equ	B_SIZE, 	256
                       200 	.equ	B_SIZE_MINUS,	255
                       201 	.equ	Q_NUM,		2
                       202 	
                       203 	.equ	TOP_OFS,	0
                       204 	.equ	OUT_OFS,	4
                       205 	.equ	IN_OFS,		8
                       206 	.equ	BOTTOM_OFS,	12
                       207 	.equ	S_OFS,		16
                       208 	.equ	Q_INFO_SIZE,	20
                       209 
                       210 	.even
000560 0000 0000       211 Q0_START: 	.ds.b	B_SIZE
       0000 0000       211 
       0000 0000       211 
       0000 0000       211 
       0000 0000       211 
000660 0000 0000       212 Q1_START: 	.ds.b	B_SIZE
       0000 0000       212 
       0000 0000       212 
       0000 0000       212 
       0000 0000       212 
                       213 	.even
                       214 Q_INFO:
000760 0000 0000       215 	.ds.b	Q_INFO_SIZE * Q_NUM
       0000 0000       215 
       0000 0000       215 
       0000 0000       215 
       0000 0000       215 
                       216 
                       217 	
                       218 ******************************
                       219 ** 書き込むデータ（サンプル）
                       220 ******************************
000788 6162 6364       221 Data_to_Que: 	.ascii	"abcdef"		/* 読み書きテスト用に1バイト確保 */
       6566            221 
                       222 
00078e 0000 0000       223 INQ_Result: .ds.l   300
       0000 0000       223 
       0000 0000       223 
       0000 0000       223 
       0000 0000       223 
000c3e 0000 0000       224 OUTQ_Data:  .ds.b   300
       0000 0000       224 
       0000 0000       224 
       0000 0000       224 
       0000 0000       224 
000d6a 0000 0000       225 OUTQ_Result:.ds.l   300
       0000 0000       225 
       0000 0000       225 
       0000 0000       225 
       0000 0000       225 
